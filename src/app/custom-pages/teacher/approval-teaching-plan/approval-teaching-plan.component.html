<div class="view-wrapper list-page crm-contact-list pb-0">
  <dx-data-grid
    class="grid theme-dependent"
    noDataText=""
    columnResizingMode="widget"
    [dataSource]="dataSource"
    [remoteOperations]="{ paging: true }"
    (onSelectionChanged)="handleSelectionChange($event)"

    [allowColumnReordering]="true"
    [showBorders]="true"
    [showColumnLines]="true"
    [showRowLines]="true"
    [columnMinWidth]="50"
    [columnAutoWidth]="true"
    [columnResizingMode]="'nextColumn'"
    [allowColumnResizing]="true"
  >
    <dxo-paging
      [pageSize]="20"
      [pageIndex]="0">
    </dxo-paging>
    <dxo-pager
      [visible]="true"
      [displayMode]="'full'"
      [showPageSizeSelector]="true"
      [showInfo]="false"
      [showNavigationButtons]="true"
    >
    </dxo-pager>
    <!--<dxo-scrolling mode="virtual" rowRenderingMode="virtual"></dxo-scrolling>-->
    <dxo-load-panel [showPane]="true" [enabled]="true"></dxo-load-panel>
    <dxo-selection
      selectAllMode="page"
      showCheckBoxesMode="always"
      mode="multiple"
    ></dxo-selection>
    <dxo-sorting mode="multiple"></dxo-sorting>
    <dxo-header-filter [visible]="false"></dxo-header-filter>
    <dxo-column-chooser [enabled]="true"></dxo-column-chooser>
    <dxo-export
      [enabled]="true"
      [allowExportSelectedData]="true"
      [formats]="['xlsx', 'pdf']"
    >
    </dxo-export>
    <dxo-toolbar>
      <dxi-item location="before">
        <div class="grid-header">
          <i class="dx-icon-textdocument" style="font-size: 16px"></i>
          Duyệt giáo án môn {{subject ? subject.name : ''}}
        </div>
      </dxi-item>
      <!--<dxi-item location="before" locateInMenu="auto">
        <label>Năm học</label>
      </dxi-item>
      <dxi-item location="before" locateInMenu="auto">
        <dx-drop-down-button
          stylingMode="text"
          [useSelectMode]="true"
          [items]="schoolYearSource"
          keyExpr="id"
          displayExpr="name"
          (onItemClick)="schoolYearChange($event)"
          [selectedItemKey]="filterSchoolYear"
          [dropDownOptions]="{ width: 'auto' }"
        ></dx-drop-down-button>
      </dxi-item>-->
      <dxi-item location="before" locateInMenu="auto">
        <label>Khối học</label>
      </dxi-item>
      <dxi-item location="before" locateInMenu="auto">
        <dx-drop-down-button
          stylingMode="text"
          [useSelectMode]="true"
          [items]="gradeSource"
          (onItemClick)="gradeChange($event)"
          [selectedItemKey]="gradeSource[0]"
          [dropDownOptions]="{ width: 'auto' }"
        ></dx-drop-down-button>
      </dxi-item>
      <dxi-item location="before" locateInMenu="auto">
        <label>Môn học</label>
      </dxi-item>
      <dxi-item location="before" locateInMenu="auto">
        <dx-drop-down-button
          stylingMode="text"
          [useSelectMode]="true"
          [items]="filterSubjectSource"
          keyExpr="id"
          displayExpr="name"
          (onItemClick)="subjectChange($event)"
          [selectedItemKey]="filterSubjectId"
          [dropDownOptions]="{ width: 'auto' }"
        ></dx-drop-down-button>
      </dxi-item>
      <dxi-item location="before" locateInMenu="auto">
        <label>Trạng thái duyệt</label>
      </dxi-item>
      <dxi-item location="before" locateInMenu="auto">
        <dx-drop-down-button
          stylingMode="text"
          [useSelectMode]="true"
          [items]="approveSource"
          keyExpr="status"
          displayExpr="name"
          (onItemClick)="statusChange($event)"
          [selectedItemKey]="approveSource[0].status"
          [dropDownOptions]="{ width: 'auto' }"
        ></dx-drop-down-button>
      </dxi-item>
    </dxo-toolbar>

    <dxi-column
      fixedPosition="left" dataField="stt" alignment="center" [allowFiltering]="false" [width]="50" caption="STT"
    ></dxi-column>

    <dxi-column title="Xem và duyệt" dataField="name" caption="Tên giáo án" cellTemplate="cellDetailLink"></dxi-column>
    <dxi-column dataField="hasTag" alignment="center" [allowFiltering]="false" [width]="120" caption="Danh mục (tag)"></dxi-column>
    <dxi-column alignment="center" dataField="dateCreated" [width]="120" caption="Ngày tạo" dataType="date"
                format="dd/MM/yyyy"></dxi-column>
    <dxi-column dataField="creator" [width]="200" caption="Giáo viên tạo"></dxi-column>
    <dxi-column alignment="center" dataField="subjectName" [width]="100" caption="Bộ môn"></dxi-column>
    <dxi-column alignment="center" dataField="grade" [width]="100" caption="Khối lớp"></dxi-column>
    <!--<dxi-column alignment="center" cellTemplate="cellSoNoiDung" caption="Số nội dung" [width]="120"></dxi-column>-->

    <dxi-column alignment="center" cellTemplate="cellTrangThai" caption="Trạng thái" [width]="120"></dxi-column>
    <dxi-column alignment="center" cellTemplate="cellFunctionTemplate" caption="Chức năng" [width]="150"></dxi-column>
    <!--<dxi-column dataField="approverName" caption="Người duyệt" cellTemplate="cellApproverName" [width]="200"></dxi-column>
    <dxi-column dataField="dateApproved" [width]="120" caption="Ngày duyệt" dataType="date"
                format="dd/MM/yyyy"></dxi-column>-->
    <!--<dxi-column cellTemplate="cellChiaSe" caption="Chia sẻ" cssClass="white-space-normal" [width]="200"></dxi-column>-->
    <div *dxTemplate="let cellInfo of 'cellFunctionTemplate'">
      <dx-button
        text="Xem và duyệt"
        [elementAttr]="{ id: 'elementId', class: 'grid-button grid-button-success' }"
        type="success"
        stylingMode="outlined"
        (onClick)="showPopupDuyet(cellInfo.data)"
      ></dx-button>
    </div>
    <!--<dxi-column type="buttons" fixedPosition="right" caption="Chức năng">
      <dxi-button
        hint="Xem và duyệt"
        cssClass="dx-button-success"
        text="Xem và duyệt"
        [onClick]="onBaiGiangDuyet"
        icon="checklist"
      ></dxi-button>
    </dxi-column>-->
    <div *dxTemplate="let cellInfo of 'cellDetailLink'">
      <a title="Xem danh sách bài giảng và duyệt" class="a-link" (click)="showPopupDuyet(cellInfo.data)">{{cellInfo.data.name}}</a>
    </div>
    <div *dxTemplate="let cellInfo of 'cellSoNoiDung'">
      {{cellInfo.data.soNoiDung}}
    </div>

    <div *dxTemplate="let cellInfo of 'cellApproverName'">
      <span *ngIf="cellInfo.data.trangThai === 10">{{cellInfo.data.approverName === '' ? 'admin' : cellInfo.data.approverName}}</span>
    </div>
    <div *dxTemplate="let cellInfo of 'cellTrangThai'">
      <span class="tag warning float-none" *ngIf="cellInfo.data.trangThaiDuyet === 0">Chờ duyệt</span>
      <span class="tag processing float-none" *ngIf="cellInfo.data.trangThaiDuyet === 10">Đã duyệt</span>
      <span class="tag red float-none no-border" *ngIf="cellInfo.data.trangThaiDuyet === 5">TCM đề nghị chỉnh sửa</span>
      <span class="tag red float-none no-border"
            *ngIf="cellInfo.data.trangThaiDuyet === 15">BGH đề nghị chỉnh sửa</span>
      <span class="tag success float-none no-border" *ngIf="cellInfo.data.trangThaiDuyet === 20">BGH đã duyệt</span>
    </div>
  </dx-data-grid>

</div>


<dx-popup
  title="Duyệt giáo án"
  [(visible)]="isShowApproveTaiLieuMode"
  class="form-popup"
  width="90%"
  height="90%"
>
  <div class="row">
    <div class="{{isShowFormNote ? 'col-7' : 'col-12'}} ">
      <div class="frame-wrapper">
        <div class="frame-title flex-space-between">
          <h6>{{taiLieuItem.name}}</h6>
          <!--Trạng thái giáo án: {{taiLieuItem.trangThaiDuyet}}-->
          <div class="buttons" *ngIf="taiLieuItem && checkButtonApproveTaiLieu()">
            <dx-button
              text="Phê duyệt"
              [elementAttr]="{ id: 'elementId', class: 'color-white' }"
              icon="todo"
              type="success"
              stylingMode="contained"
              (onClick)="doApprovedTaiLieu()"
            ></dx-button>

            <dx-button
              text="Đề nghị chỉnh sửa"
              [elementAttr]="{ id: 'elementId', class: '', style:'margin-left:10px' }"
              icon="rename"
              type="default"
              stylingMode="contained"
              (onClick)="showFormNote()"
            ></dx-button>
          </div>
        </div>
        <!--<iframe scrolling="no"
                style="border:none;overflow-x: hidden;" id="h5pFrame" width="100%"
                [height]="iframeHeight"></iframe>-->
        <ng-container>
          <div class="p-2" *ngIf="typeOfMedia(taiLieuUrl) === 'image'">
            <img style="max-width: 100%;height: auto" [src]="taiLieuUrl">
          </div>
          <div class="p-2" *ngIf="typeOfMedia(taiLieuUrl) === 'video'">
            <video width="640" height="360" controls>
              <source src="{{taiLieuUrl}}" type="video/mp4">
            </video>
          </div>
          <ngx-doc-viewer *ngIf="typeOfMedia(taiLieuUrl) === 'document'"
                          [url]="taiLieuUrl"
                          viewer="google"
                          style="width:100%;height:100vh;"
          ></ngx-doc-viewer>
          <iframe *ngIf="typeOfMedia(taiLieuUrl) === 'powerpoint'" [src]="taiLieuSafeUrl" width="100%" height="600px"></iframe>
          <iframe allow="microphone; accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" allowfullscreen  *ngIf="typeOfMedia(taiLieuUrl) === 'html'"
                  [src]="taiLieuUrl | safe"
                  width="100%"
                  height="600px"
                  frameborder="0">
          </iframe>
        </ng-container>
      </div>
    </div>
    <div class="col-5 dx-tab-border" *ngIf="isShowFormNote">
      <h6>
        Nội dung chỉnh sửa
      </h6>
      <dx-html-editor height="400px" [(value)]="taiLieuItem.yeuCauChinhSua">
        <dxo-toolbar>
          <dxi-item name="undo"></dxi-item>
          <dxi-item name="redo"></dxi-item>
          <dxi-item name="separator"></dxi-item>
          <dxi-item
            name="header"
            [acceptedValues]="[false, 1, 2, 3, 4, 5]"
            [options]="{ inputAttr: { 'aria-label': 'Header' } }"
          ></dxi-item>
          <dxi-item name="separator"></dxi-item>
          <dxi-item name="bold"></dxi-item>
          <dxi-item name="italic"></dxi-item>
          <dxi-item name="strike"></dxi-item>
          <dxi-item name="underline"></dxi-item>
          <dxi-item name="separator"></dxi-item>
          <dxi-item name="alignLeft"></dxi-item>
          <dxi-item name="alignCenter"></dxi-item>
          <dxi-item name="alignRight"></dxi-item>
          <dxi-item name="alignJustify"></dxi-item>
          <dxi-item name="separator"></dxi-item>
        </dxo-toolbar>
      </dx-html-editor>
      <div style="margin-top: 10px">
        <dx-button
          text="Gửi đề nghị"
          [elementAttr]="{ id: 'elementId', class: 'color-white' }"
          icon="todo"
          type="success"
          stylingMode="contained"
          (onClick)="tuChoiDuyetTaiLieu()"
        ></dx-button>
      </div>
    </div>
  </div>
</dx-popup>


