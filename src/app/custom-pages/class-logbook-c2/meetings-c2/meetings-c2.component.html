<div class="meetings-container">
  <!-- Header with filters -->
  <div class="header-section">
    <div class="filter-bar">
      <div class="filter-item">
        <label>Khối:</label>
        <dx-select-box
          [dataSource]="gradeSource"
          [(value)]="filterGrade"
          displayExpr="this"
          valueExpr="this"
          (onItemClick)="gradeChange($event)"
          [width]="150"
        ></dx-select-box>
      </div>

      <div class="filter-item">
        <label>Lớp:</label>
        <dx-select-box
          [dataSource]="filterClassSource"
          [(value)]="filterClassId"
          displayExpr="name"
          valueExpr="id"
          (onItemClick)="classChange($event)"
          [width]="200"
        ></dx-select-box>
      </div>

      <!-- Term filter for tab 1 & 2 -->
      <div class="filter-item" *ngIf="selectedTabIndex < 2">
        <label>Học kỳ:</label>
        <dx-select-box
          [dataSource]="termSource"
          [(value)]="selectedTerm"
          displayExpr="name"
          valueExpr="id"
          (onItemClick)="termChange($event)"
          [width]="150"
        ></dx-select-box>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <dx-tab-panel
    [dataSource]="[
      { title: '1. Sinh hoạt lớp', template: 'tab1' },
      { title: '2. Chuyên đề', template: 'tab2' },
      { title: '3. Họp chủ nhiệm', template: 'tab3' },
      { title: '4. Biên bản họp', template: 'tab4' }
    ]"
    [selectedIndex]="selectedTabIndex"
    (onSelectionChanged)="onTabChanged($event)"
    [swipeEnabled]="false"
    style="background-color: white;"
  >
    <!-- Tab 1: Sinh hoat lop -->
    <div *dxTemplate="let item of 'tab1'">
      <div class="tab-content">
        <div class="action-bar">
          <dx-button
            text="Thêm mới"
            icon="add"
            type="success"
            (onClick)="onAddNewTable()"
          ></dx-button>
        </div>

        <dx-data-grid
          #grid1
          [dataSource]="sinhHoatLopData"
          [showBorders]="true"
          [showRowLines]="true"
          [showColumnLines]="true"
          [rowAlternationEnabled]="true"
          [hoverStateEnabled]="true"
          [columnAutoWidth]="true"
          keyExpr="id"
        >
          <dxo-scrolling mode="standard"></dxo-scrolling>
          <dxo-paging [enabled]="false"></dxo-paging>

          <dxi-column caption="STT" [width]="60" alignment="center" cellTemplate="sttTemplate"></dxi-column>
          <dxi-column dataField="term" caption="Học kỳ" [width]="100" alignment="center" cellTemplate="termTemplate"></dxi-column>
          <dxi-column dataField="week" caption="Tuần học" [width]="100" alignment="center"></dxi-column>
          <dxi-column dataField="thoiGianHop" caption="Thời gian họp" [width]="150" alignment="center" dataType="date" format="dd/MM/yyyy HH:mm"></dxi-column>
          <dxi-column dataField="noiDung" caption="Nội dung" alignment="left"></dxi-column>
          <dxi-column caption="Sửa" [width]="100" alignment="center" cellTemplate="editTemplate"></dxi-column>

          <div *dxTemplate="let data of 'sttTemplate'">{{ data.rowIndex + 1 }}</div>
          <div *dxTemplate="let data of 'editTemplate'">
            <dx-button icon="edit" hint="Sửa" (onClick)="onEditTable(data.data)"></dx-button>
            <dx-button icon="trash" hint="Xóa" (onClick)="onDeleteTable(data.data)"></dx-button>
          </div>
          <div *dxTemplate="let data of 'termTemplate'">{{ getTermName(data.value) }}</div>
        </dx-data-grid>
      </div>
    </div>

    <!-- Tab 2: Chuyen de -->
    <div *dxTemplate="let item of 'tab2'">
      <div class="tab-content">
        <div class="action-bar">
          <dx-button
            text="Thêm mới"
            icon="add"
            type="success"
            (onClick)="onAddNewTable()"
          ></dx-button>
        </div>

        <dx-data-grid
          #grid2
          [dataSource]="chuyenDeData"
          [showBorders]="true"
          [showRowLines]="true"
          [showColumnLines]="true"
          [rowAlternationEnabled]="true"
          [hoverStateEnabled]="true"
          [columnAutoWidth]="true"
          keyExpr="id"
        >
          <dxo-scrolling mode="standard"></dxo-scrolling>
          <dxo-paging [enabled]="false"></dxo-paging>

          <dxi-column caption="STT" [width]="60" alignment="center" cellTemplate="sttTemplate"></dxi-column>
          <dxi-column caption="Sửa" [width]="80" alignment="center" cellTemplate="editTemplate"></dxi-column>
          <dxi-column dataField="term" caption="Học kỳ" [width]="100" alignment="center" cellTemplate="termTemplate"></dxi-column>
          <dxi-column dataField="week" caption="Tuần" [width]="100" alignment="center"></dxi-column>
          <dxi-column dataField="thoiGianHop" caption="Thời gian tổ chức" [width]="150" alignment="center" dataType="date" format="dd/MM/yyyy HH:mm"></dxi-column>
          <dxi-column dataField="diaDiem" caption="Địa điểm" [width]="200" alignment="left"></dxi-column>
          <dxi-column dataField="noiDung" caption="Dự kiến nội dung" alignment="left"></dxi-column>

          <div *dxTemplate="let data of 'sttTemplate'">{{ data.rowIndex + 1 }}</div>
          <div *dxTemplate="let data of 'editTemplate'">
            <dx-button icon="edit" hint="Sửa" (onClick)="onEditTable(data.data)"></dx-button>
            <dx-button icon="trash" hint="Xóa" (onClick)="onDeleteTable(data.data)"></dx-button>
          </div>
          <div *dxTemplate="let data of 'termTemplate'">{{ getTermName(data.value) }}</div>
        </dx-data-grid>
      </div>
    </div>

    <!-- Tab 3: Hop chu nhiem -->
    <div *dxTemplate="let item of 'tab3'">
      <div class="tab-content">
        <!-- Danh sách -->
        <div *ngIf="!isEditingInline">
          <div class="action-bar">
            <dx-button
              text="Thêm mới"
              icon="add"
              type="success"
              (onClick)="onAddNewEditor()"
            ></dx-button>
          </div>

          <div class="editor-list">
            <div class="editor-item" *ngFor="let item of hopChuNhiemData; let i = index">
              <div class="editor-header">
                <h4>{{ item.tieuDe }}</h4>
                <div class="editor-actions">
                  <dx-button icon="edit" hint="Sửa" (onClick)="onEditEditor(item)"></dx-button>
                  <dx-button icon="trash" hint="Xóa" (onClick)="onDeleteEditor(item)"></dx-button>
                </div>
              </div>
              <div class="editor-meta">
                <span *ngIf="item.thoiGianHop">{{ formatDate(item.thoiGianHop) }}</span>
              </div>
              <div class="editor-content" [innerHTML]="item.noiDung"></div>
            </div>
            <div *ngIf="!hopChuNhiemData || hopChuNhiemData.length === 0" class="no-data">
              Không có dữ liệu
            </div>
          </div>
        </div>

        <!-- Form chỉnh sửa inline -->
        <div *ngIf="isEditingInline" class="inline-editor-form">
          <h3>{{ isEditMode ? 'Cập nhật họp chủ nhiệm' : 'Thêm họp chủ nhiệm' }}</h3>

          <div class="form-group">
            <label>Thời gian <span class="required">*</span></label>
            <dx-date-box
              [(value)]="formData.thoiGianHop"
              type="datetime"
              displayFormat="dd/MM/yyyy HH:mm"
              [width]="'100%'"
            ></dx-date-box>
          </div>

          <div class="form-group">
            <label>Tiêu đề <span class="required">*</span></label>
            <dx-text-box
              [(value)]="formData.tieuDe"
              [width]="'100%'"
            ></dx-text-box>
          </div>

          <div class="form-group">
            <label>Nội dung <span class="required">*</span></label>
            <quill-editor
              [(ngModel)]="formData.noiDung"
              [modules]="quillModules"
              [styles]="{ height: '400px', marginBottom: '50px' }"
            ></quill-editor>
          </div>

          <div class="form-actions">
            <dx-button
              text="Hủy"
              type="normal"
              (onClick)="onCancel()"
              [disabled]="isSaving"
            ></dx-button>
            <dx-button
              text="Lưu"
              type="success"
              (onClick)="onSave()"
              [disabled]="isSaving"
            ></dx-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab 4: Bien ban hop -->
    <div *dxTemplate="let item of 'tab4'">
      <div class="tab-content">
        <!-- Danh sách -->
        <div *ngIf="!isEditingInline">
          <div class="action-bar">
            <dx-button
              text="Thêm mới"
              icon="add"
              type="success"
              (onClick)="onAddNewEditor()"
            ></dx-button>
          </div>

          <div class="editor-list">
            <div class="editor-item" *ngFor="let item of bienBanHopData; let i = index">
              <div class="editor-header">
                <h4>{{ item.tieuDe }}</h4>
                <div class="editor-actions">
                  <dx-button icon="edit" hint="Sửa" (onClick)="onEditEditor(item)"></dx-button>
                  <dx-button icon="trash" hint="Xóa" (onClick)="onDeleteEditor(item)"></dx-button>
                </div>
              </div>
              <div class="editor-meta">
                <span *ngIf="item.lanHop">{{ getLanHopName(item.lanHop) }}</span>
                <span *ngIf="item.thoiGianHop"> - {{ formatDate(item.thoiGianHop) }}</span>
              </div>
              <div class="editor-content" [innerHTML]="item.noiDung"></div>
            </div>
            <div *ngIf="!bienBanHopData || bienBanHopData.length === 0" class="no-data">
              Không có dữ liệu
            </div>
          </div>
        </div>

        <!-- Form chỉnh sửa inline -->
        <div *ngIf="isEditingInline" class="inline-editor-form">
          <h3>{{ isEditMode ? 'Cập nhật biên bản họp' : 'Thêm biên bản họp' }}</h3>

          <div class="form-row">
            <div class="form-group">
              <label>Biên bản họp <span class="required">*</span></label>
              <dx-select-box
                [dataSource]="lanHopSource"
                [(value)]="formData.lanHop"
                displayExpr="name"
                valueExpr="id"
                [width]="'100%'"
              ></dx-select-box>
            </div>

            <div class="form-group">
              <label>Thời gian <span class="required">*</span></label>
              <dx-date-box
                [(value)]="formData.thoiGianHop"
                type="datetime"
                displayFormat="dd/MM/yyyy HH:mm"
                [width]="'100%'"
              ></dx-date-box>
            </div>
          </div>

          <div class="form-group">
            <label>Tiêu đề <span class="required">*</span></label>
            <dx-text-box
              [(value)]="formData.tieuDe"
              [width]="'100%'"
            ></dx-text-box>
          </div>

          <div class="form-group">
            <label>Nội dung <span class="required">*</span></label>
            <quill-editor
              [(ngModel)]="formData.noiDung"
              [modules]="quillModules"
              [styles]="{ height: '400px', marginBottom: '50px' }"
            ></quill-editor>
          </div>

          <div class="form-actions">
            <dx-button
              text="Hủy"
              type="normal"
              (onClick)="onCancel()"
              [disabled]="isSaving"
            ></dx-button>
            <dx-button
              text="Lưu"
              type="success"
              (onClick)="onSave()"
              [disabled]="isSaving"
            ></dx-button>
          </div>
        </div>
      </div>
    </div>
  </dx-tab-panel>

  <!-- Popup for Tab 1 & 2 -->
  <dx-popup
    [(visible)]="popupVisible"
    [showTitle]="true"
    [title]="popupTitle"
    [dragEnabled]="false"
    [closeOnOutsideClick]="false"
    [showCloseButton]="true"
    [width]="700"
    [height]="'auto'"
    *ngIf="selectedTabIndex < 2"
  >
    <div *dxTemplate="let data of 'content'">
      <div class="popup-content">
        <div class="form-row">
          <div class="form-group">
            <label>Học kỳ <span class="required">*</span></label>
            <dx-select-box
              [dataSource]="termSource"
              [(value)]="formData.term"
              displayExpr="name"
              valueExpr="id"
              [width]="'100%'"
            ></dx-select-box>
          </div>

          <div class="form-group">
            <label>Tuần <span class="required">*</span></label>
            <dx-number-box
              [(value)]="formData.week"
              [min]="1"
              [max]="52"
              [width]="'100%'"
            ></dx-number-box>
          </div>
        </div>

        <div class="form-group">
          <label>Thời gian <span class="required">*</span></label>
          <dx-date-box
            [(value)]="formData.thoiGianHop"
            type="datetime"
            displayFormat="dd/MM/yyyy HH:mm"
            [width]="'100%'"
          ></dx-date-box>
        </div>

        <div class="form-group" *ngIf="selectedTabIndex === 1">
          <label>Địa điểm</label>
          <dx-text-box
            [(value)]="formData.diaDiem"
            [width]="'100%'"
          ></dx-text-box>
        </div>

        <div class="form-group">
          <label>Tiêu đề <span class="required">*</span></label>
          <dx-text-box
            [(value)]="formData.tieuDe"
            [width]="'100%'"
          ></dx-text-box>
        </div>

        <div class="form-group">
          <label>Nội dung <span class="required">*</span></label>
          <dx-text-area
            [(value)]="formData.noiDung"
            [height]="150"
          ></dx-text-area>
        </div>

        <div class="form-actions">
          <dx-button
            text="Hủy"
            type="normal"
            (onClick)="onCancel()"
            [disabled]="isSaving"
          ></dx-button>
          <dx-button
            text="Lưu"
            type="success"
            (onClick)="onSave()"
            [disabled]="isSaving"
          ></dx-button>
        </div>
      </div>
    </div>
  </dx-popup>

  <!-- Loading indicator -->
  <dx-load-panel
    [visible]="isLoading || isSaving"
    [showIndicator]="true"
    [showPane]="true"
    [shading]="true"
    shadingColor="rgba(0,0,0,0.4)"
    [message]="isSaving ? 'Đang lưu dữ liệu...' : 'Đang tải dữ liệu...'"
  ></dx-load-panel>
</div>
