<div class="year-end-summary-container">
  <!-- Header with filters -->
  <div class="header-section">
    <div class="filter-bar">
      <div class="filter-item">
        <label>Khối:</label>
        <dx-select-box
          [dataSource]="gradeSource"
          [(value)]="filterGrade"
          displayExpr="this"
          valueExpr="this"
          (onItemClick)="gradeChange($event)"
          [width]="150"
        ></dx-select-box>
      </div>

      <div class="filter-item">
        <label>Lớp:</label>
        <dx-select-box
          [dataSource]="filterClassSource"
          [(value)]="filterClassId"
          displayExpr="name"
          valueExpr="id"
          (onItemClick)="classChange($event)"
          [width]="200"
        ></dx-select-box>
      </div>
    </div>

    <div class="action-bar">
      <dx-button
        text="Làm mới"
        icon="refresh"
        type="default"
        (onClick)="onRefresh()"
        [disabled]="isLoading"
      ></dx-button>

      <dx-button
        text="Lưu"
        icon="save"
        type="success"
        (onClick)="onSave()"
        [disabled]="isLoading || isSaving"
      ></dx-button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-section">
    <dx-tab-panel
      [dataSource]="tabs"
      [selectedIndex]="selectedTabIndex"
      [loop]="false"
      [animationEnabled]="true"
      [swipeEnabled]="false"
      (onSelectionChanged)="onTabSelectionChanged($event)"
    >
      <div *dxTemplate="let tab of 'title'">
        <span>{{ tab.text }}</span>
      </div>

      <div *dxTemplate="let tab of 'item'">
        <!-- Tab 1: Chất lượng giáo dục 2 mặt -->
        <div *ngIf="tab.id === 0" class="quality-tab">
          <!-- Quality Tables Row -->
          <div class="quality-tables-row">
            <div class="quality-table-container">
              <dx-data-grid
                [dataSource]="qualityData"
                [showBorders]="true"
                [showRowLines]="true"
                [showColumnLines]="true"
                [columnAutoWidth]="false"
                [allowColumnResizing]="false"
                keyExpr="semester"
                (onCellPrepared)="onCellPrepared($event)"
              >
                <dxo-scrolling mode="standard"></dxo-scrolling>
                <dxo-editing mode="cell" [allowUpdating]="true"></dxo-editing>
                <dxo-paging [enabled]="false"></dxo-paging>

                <!-- Cột Xếp loại (Học kỳ I / Học kỳ II) -->
                <dxi-column
                  dataField="xepLoai"
                  caption="Xếp loại"
                  [width]="120"
                  alignment="center"
                  [allowEditing]="false"
                ></dxi-column>

                <!-- NHÓM: Chất lượng rèn luyện -->
                <dxi-column caption="Chất lượng rèn luyện" alignment="center">
                  <dxi-column caption="Tốt" alignment="center">
                    <dxi-column dataField="trainTotSoLuong" caption="Số lượng" [width]="90" dataType="number" alignment="center"></dxi-column>
                    <dxi-column dataField="trainTotTyLe" caption="Tỷ lệ" [width]="90" dataType="number" alignment="center" format="#0.##"></dxi-column>
                  </dxi-column>

                  <dxi-column caption="Khá" alignment="center">
                    <dxi-column dataField="trainKhaSoLuong" caption="Số lượng" [width]="90" dataType="number" alignment="center"></dxi-column>
                    <dxi-column dataField="trainKhaTyLe" caption="Tỷ lệ" [width]="90" dataType="number" alignment="center" format="#0.##"></dxi-column>
                  </dxi-column>

                  <dxi-column caption="Đạt" alignment="center">
                    <dxi-column dataField="trainDatSoLuong" caption="Số lượng" [width]="90" dataType="number" alignment="center"></dxi-column>
                    <dxi-column dataField="trainDatTyLe" caption="Tỷ lệ" [width]="90" dataType="number" alignment="center" format="#0.##"></dxi-column>
                  </dxi-column>

                  <dxi-column caption="Chưa đạt" alignment="center">
                    <dxi-column dataField="trainChuaDatSoLuong" caption="Số lượng" [width]="90" dataType="number" alignment="center"></dxi-column>
                    <dxi-column dataField="trainChuaDatTyLe" caption="Tỷ lệ" [width]="90" dataType="number" alignment="center" format="#0.##"></dxi-column>
                  </dxi-column>
                </dxi-column>

                <!-- NHÓM: Chất lượng học tập -->
                <dxi-column caption="Chất lượng học tập" alignment="center">
                  <dxi-column caption="Tốt" alignment="center">
                    <dxi-column dataField="learnTotSoLuong" caption="Số lượng" [width]="90" dataType="number" alignment="center"></dxi-column>
                    <dxi-column dataField="learnTotTyLe" caption="Tỷ lệ" [width]="90" dataType="number" alignment="center" format="#0.##"></dxi-column>
                  </dxi-column>

                  <dxi-column caption="Khá" alignment="center">
                    <dxi-column dataField="learnKhaSoLuong" caption="Số lượng" [width]="90" dataType="number" alignment="center"></dxi-column>
                    <dxi-column dataField="learnKhaTyLe" caption="Tỷ lệ" [width]="90" dataType="number" alignment="center" format="#0.##"></dxi-column>
                  </dxi-column>

                  <dxi-column caption="Đạt" alignment="center">
                    <dxi-column dataField="learnDatSoLuong" caption="Số lượng" [width]="90" dataType="number" alignment="center"></dxi-column>
                    <dxi-column dataField="learnDatTyLe" caption="Tỷ lệ" [width]="90" dataType="number" alignment="center" format="#0.##"></dxi-column>
                  </dxi-column>

                  <dxi-column caption="Chưa đạt" alignment="center">
                    <dxi-column dataField="learnChuaDatSoLuong" caption="Số lượng" [width]="90" dataType="number" alignment="center"></dxi-column>
                    <dxi-column dataField="learnChuaDatTyLe" caption="Tỷ lệ" [width]="90" dataType="number" alignment="center" format="#0.##"></dxi-column>
                  </dxi-column>
                </dxi-column>
              </dx-data-grid>
            </div>
          </div>

          <!-- Statistics and Achievements Row -->
          <div class="statistics-tables-row">
            <!-- Statistics -->
            <div class="statistics-table-container">
              <dx-data-grid
                [dataSource]="statisticsData"
                [showBorders]="true"
                [showRowLines]="true"
                [showColumnLines]="true"
                [columnAutoWidth]="false"
                [allowColumnResizing]="false"
                keyExpr="stt"
              >
                <dxo-scrolling mode="standard"></dxo-scrolling>
                <dxo-editing mode="cell" [allowUpdating]="true"></dxo-editing>
                <dxo-paging [enabled]="false"></dxo-paging>

                <dxi-column
                  dataField="stt"
                  caption="STT"
                  [width]="60"
                  alignment="center"
                  [allowEditing]="false"
                ></dxi-column>

                <dxi-column
                  dataField="noiDung"
                  caption="Nội dung"
                  [width]="350"
                  alignment="left"
                  [allowEditing]="false"
                ></dxi-column>

                <dxi-column
                  dataField="soLuong"
                  caption="Số lượng"
                  [width]="150"
                  alignment="center"
                  dataType="number"
                ></dxi-column>
              </dx-data-grid>
            </div>

            <!-- Achievements -->
            <div class="achievements-table-container">
              <dx-data-grid
                [dataSource]="achievementsData"
                [showBorders]="true"
                [showRowLines]="true"
                [showColumnLines]="true"
                [columnAutoWidth]="false"
                [allowColumnResizing]="false"
                keyExpr="stt"
              >
                <dxo-scrolling mode="standard"></dxo-scrolling>
                <dxo-editing mode="cell" [allowUpdating]="true"></dxo-editing>
                <dxo-paging [enabled]="false"></dxo-paging>

                <dxi-column
                  dataField="stt"
                  caption="STT"
                  [width]="60"
                  alignment="center"
                  [allowEditing]="false"
                ></dxi-column>

                <dxi-column
                  dataField="noiDung"
                  caption="Nội dung"
                  [width]="350"
                  alignment="left"
                  [allowEditing]="false"
                ></dxi-column>

                <dxi-column
                  dataField="soLuong"
                  caption="Số lượng"
                  [width]="150"
                  alignment="center"
                  dataType="number"
                ></dxi-column>
              </dx-data-grid>
            </div>
          </div>
        </div>

        <!-- Tab 2: Biện pháp giáo dục của GVCN -->
      <div *ngIf="tab.id === 1" class="solutions-tab">
        <div class="editor-block">
          <label class="editor-label">Giải pháp giáo dục GVCN và những chuyển biến của lớp</label>
          <quill-editor
            class="quill-scrollable"
            [(ngModel)]="summaryData.gvcnSolutionsAndClassChanges"
            [modules]="quillModules"
            name="gvcnSolutions"
            placeholder="Nhập nội dung..."
          ></quill-editor>
        </div>

        <div class="editor-block" style="margin-top: 30px;">
          <label class="editor-label">Các thành tích đặc biệt khác</label>
          <quill-editor
            class="quill-scrollable"
            [(ngModel)]="summaryData.otherSpecialAchievements"
            [modules]="quillModules"
            name="otherAchievements"
            placeholder="Nhập nội dung..."
          ></quill-editor>
        </div>
      </div>
      <!-- Tab 3: Hồ sơ giáo viên dạy giỏi -->
      <div *ngIf="tab.id === 2" class="teacher-report-tab">
        <!-- Report Type Selection -->
        <div class="p-3 mb-3 bg-light border rounded">
          <dx-radio-group
            [dataSource]="reportTypeOptions"
            [(value)]="selectedReportType"
            displayExpr="text"
            valueExpr="id"
            layout="horizontal"
            (onValueChanged)="onReportTypeChange($event)"
          ></dx-radio-group>
        </div>

        <!-- Template 1: Self-Assessment Report -->
        <div *ngIf="selectedReportType === 1 && teacherReport">
          <h3 class="text-center fw-bold text-uppercase mb-4 pb-2 border-bottom border-primary">MẪU BÁO CÁO TỰ BÁO CÁO THÀNH TÍCH</h3>

          <!-- I. Personal Profile -->
          <div class="mb-4 p-3 bg-light rounded border">
            <h4 class="fw-bold mb-3 border-start border-primary border-3 ps-2">I. Sơ yếu lý lịch</h4>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label fw-medium">Họ tên</label>
                <dx-text-box [(value)]="teacherReport.teacherName"></dx-text-box>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-medium">Tuổi</label>
                <dx-number-box [(value)]="teacherReport.selfAssessment.profile.age"></dx-number-box>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-medium">Giới tính</label>
                <dx-text-box [(value)]="teacherReport.selfAssessment.profile.gender"></dx-text-box>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-medium">Tuổi nghề</label>
                <dx-number-box [(value)]="teacherReport.selfAssessment.profile.yearsOfExperience"></dx-number-box>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-medium">Môn dạy</label>
                <dx-text-box [(value)]="teacherReport.selfAssessment.profile.mainSubject"></dx-text-box>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-medium">Lớp chủ nhiệm</label>
                <dx-text-box [(value)]="teacherReport.selfAssessment.profile.homeRoomClass"></dx-text-box>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-medium">Chi đội xếp loại</label>
                <dx-text-box [(value)]="teacherReport.selfAssessment.profile.teamRanking"></dx-text-box>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-medium">Chi hội CMHS xếp loại</label>
                <dx-text-box [(value)]="teacherReport.selfAssessment.profile.unionRanking"></dx-text-box>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">Thuận lợi & khó khăn về điều kiện công tác chủ nhiệm (≤ 500 ký tự)</label>
              <dx-text-area [(value)]="teacherReport.selfAssessment.profile.workingConditions" [height]="100" [maxLength]="500"></dx-text-area>
            </div>
          </div>

          <!-- II. Achievement -->
          <div class="mb-4 p-3 bg-light rounded border">
            <h4 class="fw-bold mb-3 border-start border-primary border-3 ps-2">II. Thành tích thực hiện quy chế, nề nếp, hồ sơ chủ nhiệm</h4>

            <div class="mb-3">
              <label class="form-label fw-medium">Xếp loại của tổ chủ nhiệm, ban thi đua (≤ 500 ký tự)</label>
              <dx-text-area [(value)]="teacherReport.selfAssessment.achievement.homeRoomTeamRanking" [height]="100" [maxLength]="500"></dx-text-area>
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">Những nội dung công tác chủ nhiệm đã tiến hành trong năm (≤ 500 ký tự)</label>
              <dx-text-area [(value)]="teacherReport.selfAssessment.achievement.yearlyActivities" [height]="100" [maxLength]="500"></dx-text-area>
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">Các biện pháp giáo dục đã thực hiện có hiệu quả (≤ 500 ký tự)</label>
              <dx-text-area [(value)]="teacherReport.selfAssessment.achievement.effectiveMethods" [height]="100" [maxLength]="500"></dx-text-area>
            </div>
          </div>

          <!-- III. Performance Indicators -->
          <div class="mb-4 p-3 bg-light rounded border">
            <h4 class="fw-bold mb-3 border-start border-primary border-3 ps-2">III. Hiệu quả công tác (Bảng chỉ số)</h4>

            <div class="mb-3">
              <dx-button text="Thêm dòng" icon="add" type="default" (onClick)="onAddPerformanceIndicator()"></dx-button>
            </div>

            <dx-data-grid
              [dataSource]="performanceIndicatorsData"
              [showBorders]="true"
              [showRowLines]="true"
              [showColumnLines]="true"
              keyExpr="order"
            >
              <dxo-scrolling mode="standard"></dxo-scrolling>
              <dxo-editing mode="cell" [allowUpdating]="true" [allowDeleting]="true"></dxo-editing>
              <dxo-paging [enabled]="false"></dxo-paging>

              <dxi-column dataField="order" caption="STT" [width]="80" alignment="center" [allowEditing]="false"></dxi-column>
              <dxi-column dataField="indicatorName" caption="Các chỉ số" [width]="300" alignment="left"></dxi-column>
              <dxi-column dataField="startOfYearPercent" caption="Đầu năm (%)" [width]="150" dataType="number" alignment="center" format="#0.##"></dxi-column>
              <dxi-column dataField="endOfYearPercent" caption="Cuối năm (%)" [width]="150" dataType="number" alignment="center" format="#0.##"></dxi-column>
              <dxi-column type="buttons" [width]="80">
                <dxi-button name="delete" icon="trash" (onClick)="onDeletePerformanceIndicator($event)"></dxi-button>
              </dxi-column>
            </dx-data-grid>
          </div>

          <!-- IV. Additional Information -->
          <div class="mb-4 p-3 bg-light rounded border">
            <h4 class="fw-bold mb-3 border-start border-primary border-3 ps-2">IV. Các mục đánh giá bổ sung</h4>

            <div class="mb-3">
              <label class="form-label fw-medium">Thành tích các hoạt động tập thể (≤ 500 ký tự)</label>
              <dx-text-area [(value)]="teacherReport.selfAssessment.additional.collectiveActivities" [height]="100" [maxLength]="500"></dx-text-area>
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">Những mặt hoạt động tự quản tốt (≤ 500 ký tự)</label>
              <dx-text-area [(value)]="teacherReport.selfAssessment.additional.selfManagementStrengths" [height]="100" [maxLength]="500"></dx-text-area>
            </div>

            <div class="mb-3">
              <label class="form-label fw-medium">Đặc điểm truyền thống lớp (≤ 500 ký tự)</label>
              <dx-text-area [(value)]="teacherReport.selfAssessment.additional.classTraditions" [height]="100" [maxLength]="500"></dx-text-area>
            </div>
          </div>

          <!-- Save Button for Template 1 -->
          <div class="text-center mt-4 pt-3 border-top">
            <dx-button text="Lưu báo cáo" icon="save" type="success" (onClick)="onSaveTeacherReport()" [disabled]="isSaving"></dx-button>
          </div>
        </div>

        <!-- Template 2: Innovation Report -->
        <div *ngIf="selectedReportType === 2 && teacherReport">
          <h3 class="text-center fw-bold text-uppercase mb-4 pb-2 border-bottom border-primary">MẪU BÁO CÁO SÁNG KIẾN KINH NGHIỆM</h3>

          <div class="mb-3">
            <dx-button text="Thêm sáng kiến" icon="add" type="default" (onClick)="onAddInnovation()"></dx-button>
          </div>

          <!-- Innovation Items -->
          <div *ngFor="let innovation of teacherReport.innovations; let i = index" class="mb-4 p-4 border rounded shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom innovation-header">
              <h4>Sáng kiến #{{ i + 1 }}</h4>
              <dx-button icon="trash" type="danger" (onClick)="onDeleteInnovation(i)"></dx-button>
            </div>

            <!-- I. Theoretical Basis -->
            <div class="mb-3 p-2 bg-light rounded">
              <h5 class="fw-bold mb-2 border-start border-success border-3 ps-2">I. Cơ sở thực tiễn và lý luận chọn vấn đề</h5>
              <dx-text-area [(value)]="innovation.theoreticalBasis" [height]="120" [maxLength]="500"
                placeholder="- Thực trạng, khó khăn, nhu cầu cải tiến&#10;- Cơ sở lý luận (văn bản, nghiên cứu, phương pháp)&#10;- Lý do chọn đề tài"></dx-text-area>
            </div>

            <!-- II. Implementation Methods -->
            <div class="mb-3 p-2 bg-light rounded">
              <h5 class="fw-bold mb-2 border-start border-success border-3 ps-2">II. Những biện pháp tiến hành</h5>
              <dx-text-area [(value)]="innovation.implementationMethods" [height]="120" [maxLength]="500"
                placeholder="- Các bước triển khai&#10;- Cách thức thực hiện&#10;- Công cụ, phương pháp áp dụng&#10;- Lộ trình theo từng giai đoạn"></dx-text-area>
            </div>

            <!-- III. Results -->
            <div class="mb-3 p-2 bg-light rounded">
              <h5 class="fw-bold mb-2 border-start border-success border-3 ps-2">III. Kết quả thực hiện (Có điều tra, so sánh điểm xuất phát)</h5>
              <dx-text-area [(value)]="innovation.results" [height]="120" [maxLength]="500"
                placeholder="- Số liệu trước khi thực hiện&#10;- Số liệu sau khi thực hiện&#10;- Hiệu quả đạt được&#10;- Mức độ thay đổi"></dx-text-area>
            </div>

            <!-- IV. Lessons Learned -->
            <div class="mb-3 p-2 bg-light rounded">
              <h5 class="fw-bold mb-2 border-start border-success border-3 ps-2">IV. Bài học kinh nghiệm rút ra</h5>
              <dx-text-area [(value)]="innovation.lessonsLearned" [height]="120" [maxLength]="500"
                placeholder="- Yếu tố thành công&#10;- Hạn chế&#10;- Điều cần lưu ý khi áp dụng&#10;- Khả năng nhân rộng"></dx-text-area>
            </div>
          </div>

          <!-- Save Button for Template 2 -->
          <div class="text-center mt-4 pt-3 border-top">
            <dx-button text="Lưu báo cáo" icon="save" type="success" (onClick)="onSaveTeacherReport()" [disabled]="isSaving"></dx-button>
          </div>
        </div>
      </div>
      </div>
    </dx-tab-panel>
  </div>

  <!-- Loading indicator -->
  <dx-load-panel
    [visible]="isLoading || isSaving"
    [showIndicator]="true"
    [showPane]="true"
    [shading]="true"
    shadingColor="rgba(0,0,0,0.4)"
    [message]="isSaving ? 'Đang lưu dữ liệu...' : 'Đang tải dữ liệu...'"
  ></dx-load-panel>
</div>
