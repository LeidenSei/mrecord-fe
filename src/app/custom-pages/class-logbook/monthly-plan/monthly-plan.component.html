<div class="view-wrapper monthly-plan-page">
  
  <div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
        <div class="d-flex align-items-center gap-3">
          <i class="dx-icon-event text-primary" style="font-size: 24px;"></i>
          <div>
            <h4 class="mb-1 fw-semibold">K·∫ø ho·∫°ch th√°ng {{selectedMonth}}</h4>
            <small class="text-muted">
              <!-- N·∫øu ƒëang ·ªü th√°ng 9-12 -->
              <ng-container *ngIf="selectedMonth >= 9">
                01/{{monthPadded}}/{{selectedYear}} - {{endDate}}/{{monthPadded}}/{{selectedYear}}
              </ng-container>

              <!-- N·∫øu ƒëang ·ªü th√°ng 1-8 -->
              <ng-container *ngIf="selectedMonth < 9">
                01/{{monthPadded}}/{{selectedYear + 1}} - {{endDate}}/{{monthPadded}}/{{selectedYear + 1}}
              </ng-container>

              <!-- Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß nƒÉm h·ªçc -->
              <span class="ms-2 fw-medium text-primary">
                (NƒÉm h·ªçc {{selectedYear}}-{{selectedYear + 1}})
              </span>
            </small>
          </div>
        </div>
        <span class="badge bg-primary rounded-pill" *ngIf="planCount > 0">
          {{planCount}} k·∫ø ho·∫°ch
        </span>
      </div>

      <div class="d-flex gap-3 align-items-center flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <label class="mb-0 small fw-medium">Kh·ªëi h·ªçc:</label>
          <dx-drop-down-button
            stylingMode="outlined"
            [useSelectMode]="true"
            [items]="gradeSource"
            (onItemClick)="gradeChange($event)"
            [selectedItemKey]="gradeSource[0]"
            [width]="120">
          </dx-drop-down-button>
        </div>
        
        <div class="d-flex align-items-center gap-2">
          <label class="mb-0 small fw-medium">L·ªõp h·ªçc:</label>
          <dx-drop-down-button
            stylingMode="outlined"
            [useSelectMode]="true"
            [items]="filterClassSource"
            keyExpr="id"
            displayExpr="name"
            (onItemClick)="classChange($event)"
            [selectedItemKey]="filterClassId"
            [width]="150">
          </dx-drop-down-button>
        </div>

        <div class="d-flex align-items-center gap-2">
          <label class="mb-0 small fw-medium">Th√°ng:</label>
          <dx-drop-down-button
            stylingMode="outlined"
            [useSelectMode]="true"
            [items]="monthSource"
            keyExpr="id"
            displayExpr="name"
            (onItemClick)="monthChange($event)"
            [selectedItemKey]="selectedMonth"
            [width]="120">
          </dx-drop-down-button>
        </div>

        <div class="d-flex align-items-center gap-2">
          <label class="mb-0 small fw-medium">NƒÉm:</label>
          <dx-drop-down-button
            stylingMode="outlined"
            [useSelectMode]="true"
            [items]="yearSource"
            keyExpr="id"
            displayExpr="name"
            (onItemClick)="yearChange($event)"
            [selectedItemKey]="selectedYear"
            [dropDownOptions]="{ width: 'auto' }">
          </dx-drop-down-button>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label small fw-medium text-primary">Ch·ªß ƒë·ªÅ:</label>
          <input type="text" class="form-control form-control-sm" 
                [(ngModel)]="monthlyTopic" 
                (ngModelChange)="onTopicChange()"
                placeholder="Nh·∫≠p ch·ªß ƒë·ªÅ th√°ng..." />
        </div>
        <div class="col-md-6">
          <label class="form-label small fw-medium text-primary">Tr·ªçng t√¢m:</label>
          <input type="text" class="form-control form-control-sm" 
                [(ngModel)]="monthlyFocus" 
                (ngModelChange)="onFocusChange()"
                placeholder="Nh·∫≠p tr·ªçng t√¢m th√°ng..." />
        </div>
      </div>
    </div>
  </div>

  <as-split 
    direction="horizontal" 
    class="main-splitter" 
    [gutterSize]="8" 
    unit="percent"
    (dragEnd)="onSplitDragEnd($event)">
    
    <as-split-area 
      [size]="splitSizes[0]" 
      [minSize]="10" 
      [maxSize]="90">
      <div class="card border-0 shadow-sm h-100 d-flex flex-column">
        <div class="card-header bg-primary bg-gradient text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
              <i class="dx-icon-event" style="font-size: 20px;"></i>
              <div>
                <h5 class="mb-0 fw-semibold">K·∫ø ho·∫°ch th√°ng</h5>
                <small class="opacity-75" style="font-size: 12px;">L·∫≠p k·∫ø ho·∫°ch v√† theo d√µi ti·∫øn ƒë·ªô</small>
              </div>
            </div>
            <span class="badge bg-white text-primary" *ngIf="planCount > 0">
              {{planCount}}
            </span>
          </div>
        </div>

        <div class="card-body p-3 flex-grow-1 overflow-hidden">
          <dx-data-grid
            #planGrid
            class="h-100"
            [dataSource]="monthlyPlanData"
            [showBorders]="true"
            [rowAlternationEnabled]="true"
            [columnAutoWidth]="false"
            [wordWrapEnabled]="true"
            (onExporting)="onPlanExporting($event)"
            (onRowUpdating)="onPlanRowUpdating($event)"
            (onRowInserting)="onPlanRowInserting($event)"
            (onRowRemoving)="onPlanRowRemoving($event)">

            <dxo-scrolling mode="virtual" columnRenderingMode="virtual"></dxo-scrolling>
            <dxo-column-fixing [enabled]="true"></dxo-column-fixing>
            
            <dxo-editing 
              mode="popup" 
              [allowUpdating]="true" 
              [allowAdding]="true" 
              [allowDeleting]="true"
              [confirmDelete]="true"
              [texts]="{
                saveRowChanges: 'L∆∞u',
                cancelRowChanges: 'H·ªßy',
                deleteRow: 'X√≥a',
                editRow: 'S·ª≠a',
                addRow: 'Th√™m m·ªõi',
                confirmDeleteMessage: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a k·∫ø ho·∫°ch n√†y?',
                confirmDeleteTitle: 'X√°c nh·∫≠n x√≥a'
              }">
              <dxo-popup 
                title="üìã K·∫æ HO·∫†CH TH√ÅNG" 
                [width]="750" 
                [height]="'auto'"
                [showCloseButton]="true"
                [dragEnabled]="true">
              </dxo-popup>
              <dxo-form [labelLocation]="'top'" [colCount]="1" cssClass="custom-form">
                <dxi-item itemType="group" caption="‚è∞ Th·ªùi gian th·ª±c hi·ªán" cssClass="time-group">
                  <dxi-item itemType="group" [colCount]="2" cssClass="date-row">
                    <dxi-item dataField="timeFrom" [isRequired]="true">
                      <dxo-label text="T·ª´ ng√†y" [showColon]="false"></dxo-label>
                      <dxi-validation-rule type="required" message="Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu"></dxi-validation-rule>
                    </dxi-item>
                    <dxi-item dataField="timeTo" [isRequired]="true">
                      <dxo-label text="ƒê·∫øn ng√†y" [showColon]="false"></dxo-label>
                      <dxi-validation-rule type="required" message="Vui l√≤ng ch·ªçn ng√†y k·∫øt th√∫c"></dxi-validation-rule>
                    </dxi-item>
                  </dxi-item>
                </dxi-item>
                
                <dxi-item itemType="group" caption="üìù N·ªôi dung chi ti·∫øt" cssClass="content-group">
                  <dxi-item dataField="content" editorType="dxTextArea" 
                    [editorOptions]="{height: 120, placeholder: 'Nh·∫≠p n·ªôi dung k·∫ø ho·∫°ch...'}">
                    <dxo-label text="N·ªôi dung" [showColon]="false"></dxo-label>
                  </dxi-item>
                </dxi-item>
                
                <dxi-item itemType="group" caption="‚≠ê ƒê√°nh gi√° k·∫øt qu·∫£" cssClass="evaluation-group">
                  <dxi-item dataField="evaluation" editorType="dxTextArea" 
                    [editorOptions]="{height: 100, placeholder: 'Nh·∫≠p ƒë√°nh gi√° (n·∫øu c√≥)...'}">
                    <dxo-label text="ƒê√°nh gi√°" [showColon]="false"></dxo-label>
                  </dxi-item>
                </dxi-item>
              </dxo-form>
            </dxo-editing>

            <!-- <dxo-toolbar>
              <dxi-item name="addRowButton"></dxi-item>
              <dxi-item name="exportButton"></dxi-item>
            </dxo-toolbar> -->

            <dxi-column dataField="stt" caption="STT" [width]="60" alignment="center" [allowEditing]="false"></dxi-column>
            <dxi-column dataField="timeFrom" caption="T·ª´" dataType="date" format="dd/MM/yyyy" [width]="110"></dxi-column>
            <dxi-column dataField="timeTo" caption="ƒê·∫øn" dataType="date" format="dd/MM/yyyy" [width]="110"></dxi-column>
            <dxi-column dataField="content" caption="N·ªôi dung" cellTemplate="contentTemplate"></dxi-column>
            <dxi-column dataField="evaluation" caption="ƒê√°nh gi√°" cellTemplate="evaluationTemplate" [width]="200"></dxi-column>
            <dxi-column type="buttons" [width]="80" [fixed]="true" fixedPosition="right">
              <dxi-button name="edit"></dxi-button>
              <dxi-button name="delete"></dxi-button>
            </dxi-column>
            <div *dxTemplate="let data of 'contentTemplate'">
              <div class="content-cell preserve-format">{{ data.value }}</div>
            </div>
            <div *dxTemplate="let data of 'evaluationTemplate'">
              <div class="content-cell preserve-format">{{ data.value }}</div>
            </div>
          </dx-data-grid>
        </div>
      </div>
    </as-split-area>

    <as-split-area 
      [size]="splitSizes[1]" 
      [minSize]="10" 
      [maxSize]="90">
      <div class="card border-0 shadow-sm h-100 d-flex flex-column">
        <div class="card-header bg-danger bg-gradient text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
              <i class="dx-icon-doc" style="font-size: 20px;"></i>
              <div>
                <h5 class="mb-0 fw-semibold">Nh·∫≠t k√Ω ch·ªß nhi·ªám</h5>
                <small class="opacity-75" style="font-size: 12px;">Ghi ch√©p ho·∫°t ƒë·ªông gi·∫£ng d·∫°y</small>
              </div>
            </div>
            <span class="badge bg-white text-danger" *ngIf="journalCount > 0">
              {{journalCount}}
            </span>
          </div>
        </div>

        <div class="card-body p-3 flex-grow-1 overflow-hidden">
          <dx-data-grid
            #journalGrid
            class="h-100"
            [dataSource]="teacherJournalData"
            [showBorders]="true"
            [rowAlternationEnabled]="true"
            [columnAutoWidth]="false"
            [wordWrapEnabled]="true"
            (onExporting)="onJournalExporting($event)"
            (onRowUpdating)="onJournalRowUpdating($event)"
            (onRowInserting)="onJournalRowInserting($event)"
            (onRowRemoving)="onJournalRowRemoving($event)">

            <dxo-scrolling mode="virtual" columnRenderingMode="virtual"></dxo-scrolling>
            <dxo-column-fixing [enabled]="true"></dxo-column-fixing>
            
            <dxo-editing 
              mode="popup" 
              [allowUpdating]="true" 
              [allowAdding]="true" 
              [allowDeleting]="true"
              [confirmDelete]="true"
              [texts]="{
                saveRowChanges: 'L∆∞u',
                cancelRowChanges: 'H·ªßy',
                deleteRow: 'X√≥a',
                editRow: 'S·ª≠a',
                addRow: 'Th√™m m·ªõi',
                confirmDeleteMessage: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh·∫≠t k√Ω n√†y?',
                confirmDeleteTitle: 'X√°c nh·∫≠n x√≥a'
              }">
              <dxo-popup 
                title="üìñ NH·∫¨T K√ù CH·ª¶ NHI·ªÜM" 
                [width]="700" 
                [height]="'auto'"
                [showCloseButton]="true"
                [dragEnabled]="true">
              </dxo-popup>
              <dxo-form [labelLocation]="'top'" [colCount]="1" cssClass="custom-form">
                <dxi-item itemType="group" caption="üìÖ Th√¥ng tin nh·∫≠t k√Ω" cssClass="journal-group">
                  <dxi-item dataField="date" [isRequired]="true">
                    <dxo-label text="Ng√†y ghi nh·∫≠n" [showColon]="false"></dxo-label>
                    <dxi-validation-rule type="required" message="Vui l√≤ng ch·ªçn ng√†y"></dxi-validation-rule>
                  </dxi-item>
                  
                  <dxi-item dataField="content" editorType="dxTextArea" 
                    [editorOptions]="{height: 150, placeholder: 'Nh·∫≠p n·ªôi dung nh·∫≠t k√Ω...'}">
                    <dxo-label text="N·ªôi dung chi ti·∫øt" [showColon]="false"></dxo-label>
        
                  </dxi-item>
                </dxi-item>
              </dxo-form>
            </dxo-editing>
            
            <dxo-toolbar>
              <dxi-item name="addRowButton"></dxi-item>
              <dxi-item name="exportButton"></dxi-item>
            </dxo-toolbar>

            <dxi-column dataField="stt" caption="STT" [width]="60" alignment="center" [allowEditing]="false"></dxi-column>
            <dxi-column dataField="date" caption="Th·ªùi gian" dataType="date" format="dd/MM/yyyy" [width]="120"></dxi-column>
            <dxi-column dataField="content" caption="N·ªôi dung nh·∫≠t k√≠" cellTemplate="journalContentTemplate"></dxi-column>
            <dxi-column type="buttons" [width]="110" [fixed]="true" fixedPosition="right">
              <dxi-button name="edit"></dxi-button>
              <dxi-button name="delete"></dxi-button>
            </dxi-column>
            <div *dxTemplate="let data of 'journalContentTemplate'">
              <div class="content-cell preserve-format">{{ data.value }}</div>
            </div>
          </dx-data-grid>
        </div>
      </div>
    </as-split-area>

  </as-split>
</div>