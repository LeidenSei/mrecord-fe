<div class="view-wrapper list-page homeroom-plan">
  <div class="page-header">
    <div class="header-title">
      <i class="dx-icon-bookmark"></i>
      <h2>Kế hoạch chủ nhiệm</h2>
      <span class="count-badge" *ngIf="plansCount > 0">{{plansCount}}</span>
    </div>
    
    <div class="header-actions">
      <button class="btn-add" (click)="addNewPlan()">
        <i class="dx-icon-plus"></i>
        Thêm kế hoạch mới
      </button>
      <button class="btn-export" (click)="exportData()">
        <i class="dx-icon-export"></i>
        Xuất Excel
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-container">
    <div class="filter-item">
      <label>Năm học</label>
      <dx-select-box
        [dataSource]="schoolYearSource"
        [(value)]="selectedSchoolYear"
        (onValueChanged)="onFilterChange()"
        [width]="150"
      ></dx-select-box>
    </div>

    <div class="filter-item">
      <label>Học kỳ</label>
      <dx-select-box
        [dataSource]="semesterSource"
        [(value)]="selectedSemester"
        displayExpr="name"
        valueExpr="value"
        (onValueChanged)="onFilterChange()"
        [width]="150"
      ></dx-select-box>
    </div>

    <div class="filter-item">
      <label>Lớp học</label>
      <dx-select-box
        [dataSource]="filterClassSource"
        [(value)]="filterClassId"
        displayExpr="name"
        valueExpr="id"
        (onValueChanged)="onFilterChange()"
        [width]="150"
      ></dx-select-box>
    </div>

    <div class="filter-item">
      <label>Trạng thái</label>
      <dx-select-box
        [dataSource]="filterStatusSource"
        [(value)]="selectedStatus"
        displayExpr="name"
        valueExpr="value"
        (onValueChanged)="onFilterChange()"
        [width]="150"
      ></dx-select-box>
    </div>

    <button class="btn-clear-filter" (click)="clearFilters()">
      <i class="dx-icon-clear"></i>
      Xóa bộ lọc
    </button>
  </div>

  <!-- Plans List -->
  <div class="plans-container" *ngIf="filteredDatas.length > 0">
    <div class="plan-card" *ngFor="let plan of filteredDatas">
      <!-- Card Header -->
      <div class="card-header">
        <div class="card-header-left">
          <h3 class="plan-title">
            <span class="year-badge">{{plan.schoolYear}}</span>
            <span [ngClass]="getSemesterClass(plan.semester)">
              {{getSemesterText(plan.semester)}}
            </span>
            <span class="class-badge">{{plan.className}}</span>
          </h3>
          <div class="plan-meta">
            <span class="teacher-name">
              <i class="dx-icon-user"></i>
              {{plan.teacherName}}
            </span>
            <span class="plan-date">
              <i class="dx-icon-event"></i>
              {{plan.planDate | date:'dd/MM/yyyy'}}
            </span>
          </div>
        </div>
        <div class="card-header-right">
          <span [ngClass]="getStatusClass(plan.status)">
            {{getStatusText(plan.status)}}
          </span>
          <div class="card-actions">
            <button class="btn-icon" (click)="editPlan(plan)" title="Chỉnh sửa">
              <i class="dx-icon-edit"></i>
            </button>
            <button class="btn-icon btn-delete" (click)="deletePlan(plan)" title="Xóa">
              <i class="dx-icon-trash"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Card Content -->
      <div class="card-content">
        <!-- Section A -->
        <div class="section section-a">
          <h4 class="section-title">A. TÌNH HÌNH CHUNG</h4>
          <div class="section-content">
            <div class="content-item">
              <div class="item-label">
                <i class="dx-icon-check"></i>
                <strong>Thuận lợi:</strong>
              </div>
              <div class="item-text">{{plan.advantages}}</div>
            </div>
            <div class="content-item">
              <div class="item-label">
                <i class="dx-icon-warning"></i>
                <strong>Khó khăn:</strong>
              </div>
              <div class="item-text">{{plan.difficulties}}</div>
            </div>
          </div>
        </div>

        <!-- Section B -->
        <div class="section section-b">
          <h4 class="section-title">B. KẾ HOẠCH GIÁO DỤC</h4>
          
          <!-- Subsection 1 -->
          <div class="subsection">
            <h5 class="subsection-title">
              <span class="number">1</span>
              TRUYỀN THỐNG - ĐẠO ĐỨC - LỐI SỐNG
            </h5>
            <div class="subsection-content">
              <div class="content-row">
                <span class="content-label">a) Mục tiêu:</span>
                <span class="content-text">{{plan.tradition_objectives}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">b) Nội dung:</span>
                <span class="content-text">{{plan.tradition_content}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">c) Giải pháp:</span>
                <span class="content-text">{{plan.tradition_solutions}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">d) Kết quả mong đợi:</span>
                <span class="content-text">{{plan.tradition_expected_results}}</span>
              </div>
            </div>
          </div>

          <!-- Subsection 2 -->
          <div class="subsection">
            <h5 class="subsection-title">
              <span class="number">2</span>
              HỌC TẬP
            </h5>
            <div class="subsection-content">
              <div class="content-row">
                <span class="content-label">a) Mục tiêu:</span>
                <span class="content-text">{{plan.academic_objectives}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">b) Nội dung:</span>
                <span class="content-text">{{plan.academic_content}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">c) Giải pháp:</span>
                <span class="content-text">{{plan.academic_solutions}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">d) Kết quả mong đợi:</span>
                <span class="content-text">{{plan.academic_expected_results}}</span>
              </div>
            </div>
          </div>

          <!-- Subsection 3 -->
          <div class="subsection">
            <h5 class="subsection-title">
              <span class="number">3</span>
              CÁC MẶT GIÁO DỤC NGOẠI KHÓA
            </h5>
            <div class="subsection-content">
              <div class="content-row">
                <span class="content-label">a) Mục tiêu:</span>
                <span class="content-text">{{plan.extracurricular_objectives}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">b) Nội dung:</span>
                <span class="content-text">{{plan.extracurricular_content}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">c) Giải pháp:</span>
                <span class="content-text">{{plan.extracurricular_solutions}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">d) Kết quả mong đợi:</span>
                <span class="content-text">{{plan.extracurricular_expected_results}}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Additional Info -->
        <div class="additional-info" *ngIf="plan.approvedBy || plan.notes">
          <div class="info-item" *ngIf="plan.approvedBy">
            <i class="dx-icon-user"></i>
            <strong>Người duyệt:</strong> {{plan.approvedBy}}
          </div>
          <div class="info-item" *ngIf="plan.notes">
            <i class="dx-icon-comment"></i>
            <strong>Ghi chú:</strong> {{plan.notes}}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="filteredDatas.length === 0">
    <i class="dx-icon-info"></i>
    <h3>Chưa có kế hoạch nào</h3>
    <p>Nhấn nút "Thêm kế hoạch mới" để tạo kế hoạch chủ nhiệm</p>
  </div>

  <!-- Popup for Add/Edit -->
  <dx-popup
    [(visible)]="popupVisible"
    [showTitle]="true"
    [title]="isEditMode ? 'Chỉnh sửa kế hoạch' : 'Thêm kế hoạch mới'"
    [width]="1000"
    [height]="'90vh'"
    [dragEnabled]="false"
    [closeOnOutsideClick]="false"
  >
    <dxi-toolbar-item
      widget="dxButton"
      toolbar="bottom"
      location="after"
      [options]="{
        text: 'Lưu',
        type: 'default',
        onClick: savePlan.bind(this)
      }"
    ></dxi-toolbar-item>
    <dxi-toolbar-item
      widget="dxButton"
      toolbar="bottom"
      location="after"
      [options]="{
        text: 'Hủy',
        onClick: closePopup.bind(this)
      }"
    ></dxi-toolbar-item>

    <div *dxTemplate="let data of 'content'">
      <dx-scroll-view>
        <dx-form
          [(formData)]="currentPlan"
          [colCount]="1"
          labelLocation="top"
        >
          <!-- Basic Info -->
          <dxi-item itemType="group" caption="THÔNG TIN CƠ BẢN" [colCount]="3" cssClass="basic-info-group">
            <dxi-item dataField="schoolYear" [isRequired]="true">
              <dxo-label text="Năm học"></dxo-label>
              <dxi-validation-rule type="required" message="Vui lòng chọn năm học"></dxi-validation-rule>
            </dxi-item>
            <dxi-item dataField="semester" [isRequired]="true" editorType="dxSelectBox"
              [editorOptions]="{
                dataSource: semesterSource,
                displayExpr: 'name',
                valueExpr: 'value'
              }">
              <dxo-label text="Học kỳ"></dxo-label>
              <dxi-validation-rule type="required" message="Vui lòng chọn học kỳ"></dxi-validation-rule>
            </dxi-item>
            <dxi-item dataField="className" [isRequired]="true" editorType="dxSelectBox"
              [editorOptions]="{
                dataSource: classSource,
                displayExpr: 'name',
                valueExpr: 'name'
              }">
              <dxo-label text="Lớp"></dxo-label>
              <dxi-validation-rule type="required" message="Vui lòng chọn lớp"></dxi-validation-rule>
            </dxi-item>
            <dxi-item dataField="teacherName" [isRequired]="true" [colSpan]="2">
              <dxo-label text="Giáo viên chủ nhiệm"></dxo-label>
              <dxi-validation-rule type="required" message="Vui lòng nhập tên giáo viên"></dxi-validation-rule>
            </dxi-item>
            <dxi-item dataField="planDate" [isRequired]="true" editorType="dxDateBox">
              <dxo-label text="Ngày lập kế hoạch"></dxo-label>
              <dxi-validation-rule type="required" message="Vui lòng chọn ngày"></dxi-validation-rule>
            </dxi-item>
          </dxi-item>

          <!-- Section A -->
          <dxi-item itemType="group" caption="A. TÌNH HÌNH CHUNG" [colCount]="1" cssClass="section-a">
            <dxi-item dataField="advantages" 
              editorType="dxTextArea" 
              [editorOptions]="{ height: 100, placeholder: 'Nhập những thuận lợi trong công tác giáo dục lớp...' }">
              <dxo-label text="1. Thuận lợi"></dxo-label>
            </dxi-item>
            <dxi-item dataField="difficulties" 
              editorType="dxTextArea" 
              [editorOptions]="{ height: 100, placeholder: 'Nhập những khó khăn cần giải quyết...' }">
              <dxo-label text="2. Khó khăn"></dxo-label>
            </dxi-item>
          </dxi-item>

          <!-- Section B -->
          <dxi-item itemType="group" caption="B. KẾ HOẠCH GIÁO DỤC" [colCount]="1" cssClass="section-b">
            
            <!-- Subsection 1 -->
            <dxi-item itemType="group" caption="1. TRUYỀN THỐNG - ĐẠO ĐỨC - LỐI SỐNG" [colCount]="1" cssClass="subsection">
              <dxi-item dataField="tradition_objectives" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập mục tiêu giáo dục về truyền thống, đạo đức, lối sống...' }">
                <dxo-label text="a) Mục tiêu"></dxo-label>
              </dxi-item>
              <dxi-item dataField="tradition_content" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập nội dung giáo dục cụ thể...' }">
                <dxo-label text="b) Nội dung"></dxo-label>
              </dxi-item>
              <dxi-item dataField="tradition_solutions" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập các giải pháp, phương pháp thực hiện...' }">
                <dxo-label text="c) Những giải pháp"></dxo-label>
              </dxi-item>
              <dxi-item dataField="tradition_expected_results" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập kết quả mong đợi, mục tiêu cần đạt được...' }">
                <dxo-label text="d) Kết quả mong đợi"></dxo-label>
              </dxi-item>
            </dxi-item>

            <!-- Subsection 2 -->
            <dxi-item itemType="group" caption="2. HỌC TẬP" [colCount]="1" cssClass="subsection">
              <dxi-item dataField="academic_objectives" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập mục tiêu về học tập của lớp...' }">
                <dxo-label text="a) Mục tiêu"></dxo-label>
              </dxi-item>
              <dxi-item dataField="academic_content" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập nội dung hướng dẫn, hỗ trợ học tập...' }">
                <dxo-label text="b) Nội dung"></dxo-label>
              </dxi-item>
              <dxi-item dataField="academic_solutions" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập giải pháp nâng cao chất lượng học tập...' }">
                <dxo-label text="c) Những giải pháp"></dxo-label>
              </dxi-item>
              <dxi-item dataField="academic_expected_results" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập kết quả kỳ vọng về học tập...' }">
                <dxo-label text="d) Kết quả mong đợi"></dxo-label>
              </dxi-item>
            </dxi-item>

            <!-- Subsection 3 -->
            <dxi-item itemType="group" caption="3. CÁC MẶT GIÁO DỤC NGOẠI KHÓA" [colCount]="1" cssClass="subsection">
              <dxi-item dataField="extracurricular_objectives" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập mục tiêu về hoạt động ngoại khóa...' }">
                <dxo-label text="a) Mục tiêu"></dxo-label>
              </dxi-item>
              <dxi-item dataField="extracurricular_content" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập nội dung các hoạt động ngoại khóa dự kiến...' }">
                <dxo-label text="b) Nội dung"></dxo-label>
              </dxi-item>
              <dxi-item dataField="extracurricular_solutions" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập giải pháp tổ chức hiệu quả các hoạt động...' }">
                <dxo-label text="c) Những giải pháp"></dxo-label>
              </dxi-item>
              <dxi-item dataField="extracurricular_expected_results" 
                editorType="dxTextArea" 
                [editorOptions]="{ height: 90, placeholder: 'Nhập kết quả mong đợi về hoạt động ngoại khóa...' }">
                <dxo-label text="d) Kết quả mong đợi"></dxo-label>
              </dxi-item>
            </dxi-item>
          </dxi-item>

          <!-- Additional Info -->
          <dxi-item itemType="group" caption="THÔNG TIN BỔ SUNG" [colCount]="2" cssClass="additional-info">
            <dxi-item dataField="status" editorType="dxSelectBox"
              [editorOptions]="{
                dataSource: statusSource,
                displayExpr: 'name',
                valueExpr: 'value'
              }">
              <dxo-label text="Trạng thái"></dxo-label>
            </dxi-item>
            <dxi-item dataField="approvedBy">
              <dxo-label text="Người duyệt"></dxo-label>
            </dxi-item>
            <dxi-item dataField="notes" [colSpan]="2"
              editorType="dxTextArea" 
              [editorOptions]="{ height: 80, placeholder: 'Ghi chú bổ sung (nếu có)...' }">
              <dxo-label text="Ghi chú"></dxo-label>
            </dxi-item>
          </dxi-item>
        </dx-form>
      </dx-scroll-view>
    </div>
  </dx-popup>
</div>