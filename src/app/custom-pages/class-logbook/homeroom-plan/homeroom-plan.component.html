<div class="view-wrapper list-page homeroom-plan">
<!-- PAGE HEADER - Fix alignment -->
<div class="d-flex justify-content-between align-items-center bg-white rounded shadow-sm p-4 mb-4">
  <!-- LEFT SIDE -->
  <div class="d-flex align-items-center gap-3">
    <i class="dx-icon-bookmark text-primary" style="font-size: 28px; line-height: 1;"></i>
    <h2 class="mb-0 fw-semibold" style="line-height: 1;">K·∫ø ho·∫°ch ch·ªß nhi·ªám</h2>
    <span class="badge rounded-pill count-badge d-flex align-items-center justify-content-center" 
          *ngIf="plansCount > 0"
          style="min-width: 32px; height: 28px;">
      {{plansCount}}
    </span>
  </div>
  
  <!-- RIGHT SIDE -->
  <div class="d-flex gap-2">
    <dx-button 
      text="Th√™m k·∫ø ho·∫°ch m·ªõi"
      icon="plus"
      type="default"
      height="40"
      (onClick)="addNewPlan()">
    </dx-button>
    
    <dx-button 
      text="Xu·∫•t Excel"
      icon="export"
      stylingMode="outlined"
      height="40"
      (onClick)="exportData()">
    </dx-button>
  </div>
</div>

  <!-- FILTERS -->
  <div class="d-flex gap-3 flex-wrap align-items-end bg-white rounded shadow-sm p-4 mb-4">
    <div class="d-flex flex-column gap-2">
      <label class="form-label mb-0 fw-medium small">NƒÉm h·ªçc</label>
      <dx-select-box
        [dataSource]="schoolYearSource"
        [(value)]="selectedSchoolYear"
        (onValueChanged)="onFilterChange()"
        [width]="150"
      ></dx-select-box>
    </div>

    <div class="d-flex flex-column gap-2">
      <label class="form-label mb-0 fw-medium small">H·ªçc k·ª≥</label>
      <dx-select-box
        [dataSource]="semesterSource"
        [(value)]="selectedSemester"
        displayExpr="name"
        valueExpr="value"
        (onValueChanged)="onFilterChange()"
        [width]="150"
      ></dx-select-box>
    </div>

    <div class="d-flex flex-column gap-2">
      <label class="form-label mb-0 fw-medium small">L·ªõp h·ªçc</label>
      <dx-select-box
        [dataSource]="classSourceWithAll"
        [(value)]="filterClassId"
        displayExpr="name"
        valueExpr="id"
        (onValueChanged)="onFilterChange()"
        [width]="200"
      ></dx-select-box>
    </div>

    <div class="d-flex flex-column gap-2">
      <label class="form-label mb-0 fw-medium small">Tr·∫°ng th√°i</label>
      <dx-select-box
        [dataSource]="filterStatusSource"
        [(value)]="selectedStatus"
        displayExpr="name"
        valueExpr="value"
        (onValueChanged)="onFilterChange()"
        [width]="150"
      ></dx-select-box>
    </div>

    <button class="btn btn-light border d-flex align-items-center gap-2" (click)="clearFilters()">
      <i class="dx-icon-clear"></i>
      <span>X√≥a b·ªô l·ªçc</span>
    </button>
  </div>

  <!-- PLANS CONTAINER -->
  <div class="d-flex flex-column gap-4" *ngIf="filteredDatas.length > 0">
    <div class="card border-0 shadow-sm plan-card" *ngFor="let plan of filteredDatas">
      
      <!-- PLAN CARD HEADER - Full Inline Styles -->
      <div style="display: flex; 
                  justify-content: space-between; 
                  align-items: center; 
                  padding: 20px 24px; 
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                  color: white; 
                  gap: 20px;">
        
        <!-- LEFT SECTION -->
        <div style="display: flex; 
                    align-items: center; 
                    gap: 16px; 
                    flex: 1; 
                    min-width: 0;">
          
          <!-- Toggle Button -->
          <button (click)="toggleCard(plan.id!)"
                  [title]="isCardCollapsed(plan.id!) ? 'M·ªü chi ti·∫øt' : 'ƒê√≥ng chi ti·∫øt'"
                  style="width: 36px; 
                        height: 36px; 
                        background: rgba(255, 255, 255, 0.15); 
                        border: none; 
                        border-radius: 8px; 
                        color: white; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        cursor: pointer; 
                        transition: all 0.2s;"
                  onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'; this.style.transform='scale(1.05)'"
                  onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'; this.style.transform='scale(1)'">
            <i [class]="isCardCollapsed(plan.id!) ? 'dx-icon-chevrondown' : 'dx-icon-chevronup'" 
              style="font-size: 18px;"></i>
          </button>
          
          <!-- Content -->
          <div style="display: flex; 
                      flex-direction: column; 
                      gap: 10px; 
                      flex: 1; 
                      min-width: 0;">
            
            <!-- Title Row with Badges -->
            <div style="display: flex; 
                        align-items: center; 
                        gap: 8px; 
                        flex-wrap: wrap;">
              
              <!-- Year Badge -->
              <span style="display: inline-flex; 
                          align-items: center; 
                          justify-content: center; 
                          padding: 5px 12px; 
                          border-radius: 6px; 
                          font-size: 13px; 
                          font-weight: 500; 
                          line-height: 1.4; 
                          white-space: nowrap; 
                          height: 28px; 
                          background: rgba(255, 255, 255, 0.2); 
                          backdrop-filter: blur(10px);">
                {{plan.schoolYear}}-{{plan.schoolYear + 1}}
              </span>
              
              <!-- Semester Badge -->
              <span [style.background]="plan.semester === 1 ? 'rgba(33, 150, 243, 0.9)' : 'rgba(76, 175, 80, 0.9)'"
                    [style.box-shadow]="plan.semester === 1 ? '0 2px 4px rgba(33, 150, 243, 0.3)' : '0 2px 4px rgba(76, 175, 80, 0.3)'"
                    style="display: inline-flex; 
                          align-items: center; 
                          justify-content: center; 
                          padding: 5px 12px; 
                          border-radius: 6px; 
                          font-size: 13px; 
                          font-weight: 500; 
                          line-height: 1.4; 
                          white-space: nowrap; 
                          height: 28px;">
                {{getSemesterText(plan.semester)}}
              </span>
              
              <!-- Class Badge -->
              <span style="display: inline-flex; 
                          align-items: center; 
                          justify-content: center; 
                          padding: 5px 12px; 
                          border-radius: 6px; 
                          font-size: 13px; 
                          font-weight: 600; 
                          line-height: 1.4; 
                          white-space: nowrap; 
                          height: 28px; 
                          background: rgba(255, 255, 255, 0.25); 
                          backdrop-filter: blur(10px); 
                          letter-spacing: 0.3px;">
                {{plan.className}}
              </span>
            </div>
            
            <!-- Meta Info -->
            <div style="display: flex; 
                        align-items: center; 
                        gap: 20px; 
                        font-size: 13px; 
                        opacity: 0.95; 
                        flex-wrap: wrap;">
              
              <span style="display: inline-flex; 
                          align-items: center; 
                          gap: 6px; 
                          white-space: nowrap;">
                <i class="dx-icon-user" style="font-size: 14px; opacity: 0.9;"></i>
                {{plan.homeRoomTeacherName}}
              </span>
              
              <span style="display: inline-flex; 
                          align-items: center; 
                          gap: 6px; 
                          white-space: nowrap;">
                <i class="dx-icon-event" style="font-size: 14px; opacity: 0.9;"></i>
                {{plan.planDate | date:'dd/MM/yyyy'}}
              </span>
            </div>
          </div>
        </div>
        
        <!-- RIGHT SECTION -->
        <div style="display: flex; 
                    flex-direction: column; 
                    align-items: flex-end; 
                    gap: 12px;">
          
          <!-- Status Badge -->
          <span [ngClass]="getStatusClass(plan.status)"
                style="display: inline-flex; 
                      align-items: center; 
                      justify-content: center; 
                      padding: 5px 14px; 
                      border-radius: 20px; 
                      font-size: 12px; 
                      font-weight: 500; 
                      white-space: nowrap; 
                      height: 28px; 
                      min-width: 80px; 
                      backdrop-filter: blur(10px);">
            {{getStatusText(plan.status)}}
          </span>
          
          <!-- Action Buttons -->
          <div style="display: flex; gap: 8px;">
            
            <button (click)="editPlan(plan)" 
                    title="Ch·ªânh s·ª≠a"
                    style="width: 36px; 
                          height: 36px; 
                          background: rgba(255, 255, 255, 0.15); 
                          border: none; 
                          border-radius: 8px; 
                          color: white; 
                          display: flex; 
                          align-items: center; 
                          justify-content: center; 
                          cursor: pointer; 
                          transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(255, 255, 255, 0.25)'; this.style.transform='scale(1.08)'; this.style.boxShadow='0 2px 8px rgba(255, 255, 255, 0.3)'"
                    onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'; this.style.transform='scale(1)'; this.style.boxShadow='none'">
              <i class="dx-icon-edit" style="font-size: 16px;"></i>
            </button>
            
            <button (click)="deletePlan(plan)" 
                    title="X√≥a"
                    style="width: 36px; 
                          height: 36px; 
                          background: rgba(255, 255, 255, 0.15); 
                          border: none; 
                          border-radius: 8px; 
                          color: white; 
                          display: flex; 
                          align-items: center; 
                          justify-content: center; 
                          cursor: pointer; 
                          transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(244, 67, 54, 0.9)'; this.style.transform='scale(1.08)'; this.style.boxShadow='0 2px 8px rgba(244, 67, 54, 0.4)'"
                    onmouseout="this.style.background='rgba(255, 255, 255, 0.15)'; this.style.transform='scale(1)'; this.style.boxShadow='none'">
              <i class="dx-icon-trash" style="font-size: 16px;"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- CARD CONTENT -->
      <div class="card-body p-4" *ngIf="!isCardCollapsed(plan.id!)">
        
        <!-- SECTION A -->
        <div class="mb-4 section-a" *ngIf="plan.semester === 1">
          <h4 class="border-bottom border-3 pb-2 mb-3 fw-semibold section-title-a">
            A. T√åNH H√åNH CHUNG
          </h4>
          
          <div class="mb-3 p-3 rounded border-start border-4 content-item-a">
            <div class="d-flex align-items-center gap-2 mb-2 fw-semibold small text-danger">
              <i class="dx-icon-check"></i>
              <span>Thu·∫≠n l·ª£i:</span>
            </div>
            <div class="small lh-base text-secondary">{{plan.advantages}}</div>
          </div>
          
          <div class="p-3 rounded border-start border-4 content-item-a">
            <div class="d-flex align-items-center gap-2 mb-2 fw-semibold small text-danger">
              <i class="dx-icon-warning"></i>
              <span>Kh√≥ khƒÉn:</span>
            </div>
            <div class="small lh-base text-secondary">{{plan.difficulties}}</div>
          </div>
        </div>

        <!-- SECTION B -->
        <div class="section-b">
          <h4 class="border-bottom border-3 pb-2 mb-3 fw-semibold section-title-b">
            B. K·∫æ HO·∫†CH GI√ÅO D·ª§C
          </h4>
          
          <!-- Subsection 1 -->
          <div class="mb-4 p-3 rounded border-start border-4 bg-light subsection-b">
            <h5 class="d-flex align-items-center gap-3 mb-3 fw-semibold small text-primary">
              <span class="badge rounded-circle bg-info d-flex align-items-center justify-content-center" 
                    style="width: 28px; height: 28px;">1</span>
              TRUY·ªÄN TH·ªêNG - ƒê·∫†O ƒê·ª®C - L·ªêI S·ªêNG
            </h5>
            
            <div class="small">
              <div class="d-flex gap-3 mb-2">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">a) M·ª•c ti√™u:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.traditionEducation.objectives}}</span>
              </div>
              <div class="d-flex gap-3 mb-2">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">b) N·ªôi dung:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.traditionEducation.content}}</span>
              </div>
              <div class="d-flex gap-3 mb-2">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">c) Gi·∫£i ph√°p:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.traditionEducation.solutions}}</span>
              </div>
              <div class="d-flex gap-3">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">d) K·∫øt qu·∫£ mong ƒë·ª£i:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.traditionEducation.expectedResults}}</span>
              </div>
            </div>
          </div>

          <!-- Subsection 2 -->
          <div class="mb-4 p-3 rounded border-start border-4 bg-light subsection-b">
            <h5 class="d-flex align-items-center gap-3 mb-3 fw-semibold small text-primary">
              <span class="badge rounded-circle bg-info d-flex align-items-center justify-content-center" 
                    style="width: 28px; height: 28px;">2</span>
              H·ªåC T·∫¨P
            </h5>
            
            <div class="small">
              <div class="d-flex gap-3 mb-2">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">a) M·ª•c ti√™u:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.academicEducation.objectives}}</span>
              </div>
              <div class="d-flex gap-3 mb-2">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">b) N·ªôi dung:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.academicEducation.content}}</span>
              </div>
              <div class="d-flex gap-3 mb-2">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">c) Gi·∫£i ph√°p:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.academicEducation.solutions}}</span>
              </div>
              <div class="d-flex gap-3">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">d) K·∫øt qu·∫£ mong ƒë·ª£i:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.academicEducation.expectedResults}}</span>
              </div>
            </div>
          </div>

          <!-- Subsection 3 -->
          <div class="p-3 rounded border-start border-4 bg-light subsection-b">
            <h5 class="d-flex align-items-center gap-3 mb-3 fw-semibold small text-primary">
              <span class="badge rounded-circle bg-info d-flex align-items-center justify-content-center" 
                    style="width: 28px; height: 28px;">3</span>
              C√ÅC M·∫∂T GI√ÅO D·ª§C NGO·∫†I KH√ìA
            </h5>
            
            <div class="small">
              <div class="d-flex gap-3 mb-2">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">a) M·ª•c ti√™u:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.extracurricularEducation.objectives}}</span>
              </div>
              <div class="d-flex gap-3 mb-2">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">b) N·ªôi dung:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.extracurricularEducation.content}}</span>
              </div>
              <div class="d-flex gap-3 mb-2">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">c) Gi·∫£i ph√°p:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.extracurricularEducation.solutions}}</span>
              </div>
              <div class="d-flex gap-3">
                <span class="fw-semibold text-nowrap" style="min-width: 140px;">d) K·∫øt qu·∫£ mong ƒë·ª£i:</span>
                <span class="flex-grow-1 lh-base text-secondary">{{plan.extracurricularEducation.expectedResults}}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ADDITIONAL INFO -->
        <div class="mt-4 p-3 rounded border-start border-4 border-warning bg-warning bg-opacity-10" *ngIf="plan.notes">
          <div class="d-flex align-items-start gap-2 small text-secondary">
            <i class="dx-icon-comment text-warning mt-1"></i>
            <strong class="text-dark">Ghi ch√∫:</strong>
            <span>{{plan.notes}}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- EMPTY STATE -->
  <div class="text-center py-5 bg-white rounded shadow-sm" *ngIf="filteredDatas.length === 0 && !isLoading">
    <i class="dx-icon-info display-1 text-secondary opacity-25 mb-3"></i>
    <h3 class="mb-2">Ch∆∞a c√≥ k·∫ø ho·∫°ch n√†o</h3>
    <p class="text-secondary">Nh·∫•n n√∫t "Th√™m k·∫ø ho·∫°ch m·ªõi" ƒë·ªÉ t·∫°o k·∫ø ho·∫°ch ch·ªß nhi·ªám</p>
  </div>

  <!-- WIZARD POPUP - GI·ªÆ NGUY√äN -->
  <dx-popup
    [(visible)]="popupVisible"
    [showTitle]="true"
    [title]="isEditMode ? 'Ch·ªânh s·ª≠a k·∫ø ho·∫°ch' : 'Th√™m k·∫ø ho·∫°ch m·ªõi'"
    [width]="800"
    [height]="600"
    [dragEnabled]="false"
    [closeOnOutsideClick]="false"
  >
    <div *dxTemplate="let data of 'content'">
      <div style="height: 100%;">
        <!-- STEP INDICATOR -->
        <div class="d-flex justify-content-between mb-4">
          <div *ngFor="let step of [1,2,3,4,5,6]; let i = index" 
               class="flex-fill text-center step-item"
               [class.active]="currentStep === step"
               (click)="goToStep(step)">
            <div class="step-circle mx-auto mb-2" [class.active]="currentStep >= step">
              {{step}}
            </div>
            <small>{{getStepName(step)}}</small>
          </div>
        </div>

        <!-- STEP CONTENT -->
        <div class="p-3">
          <!-- Step 1 -->
          <div *ngIf="currentStep === 1">
            <h3 class="mb-4">üìã Th√¥ng tin c∆° b·∫£n</h3>
            
            <div class="mb-3">
              <label class="form-label fw-medium">NƒÉm h·ªçc *</label>
              <input type="number" class="form-control" [(ngModel)]="tempFormData.schoolYear" />
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-medium">H·ªçc k·ª≥ *</label>
              <select class="form-select" [(ngModel)]="tempFormData.semester">
                <option [value]="1">H·ªçc k·ª≥ I</option>
                <option [value]="2">H·ªçc k·ª≥ II</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-medium">L·ªõp *</label>
              <select class="form-select" [(ngModel)]="tempFormData.classId">
                <option *ngFor="let cls of classSource" [value]="cls.id">{{cls.name}}</option>
              </select>
            </div>
          </div>

          <!-- Step 2 -->
          <div *ngIf="currentStep === 2">
            <h3 class="mb-4">üìä T√¨nh h√¨nh chung</h3>
            
            <div class="mb-3">
              <label class="form-label fw-medium">Thu·∫≠n l·ª£i</label>
              <textarea class="form-control" rows="6" [(ngModel)]="tempFormData.advantages"
                        placeholder="Nh·∫≠p nh·ªØng thu·∫≠n l·ª£i trong c√¥ng t√°c gi√°o d·ª•c l·ªõp..."></textarea>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-medium">Kh√≥ khƒÉn</label>
              <textarea class="form-control" rows="6" [(ngModel)]="tempFormData.difficulties"
                        placeholder="Nh·∫≠p nh·ªØng kh√≥ khƒÉn c·∫ßn gi·∫£i quy·∫øt..."></textarea>
            </div>
          </div>

          <!-- Steps 3, 4, 5 t∆∞∆°ng t·ª±... -->
          
          <!-- Step 6 -->
          <div *ngIf="currentStep === 6">
            <h3 class="mb-4">üìù Ho√†n t·∫•t</h3>
            
            <div class="mb-3">
              <label class="form-label fw-medium">Tr·∫°ng th√°i</label>
              <select class="form-select" [(ngModel)]="tempFormData.status">
                <option value="draft">B·∫£n nh√°p</option>
                <option value="submitted">ƒê√£ n·ªôp</option>
                <option value="approved">ƒê√£ duy·ªát</option>
                <option value="rejected">C·∫ßn s·ª≠a</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-medium">Ghi ch√∫</label>
              <textarea class="form-control" rows="8" [(ngModel)]="tempFormData.notes"
                        placeholder="Ghi ch√∫ b·ªï sung (n·∫øu c√≥)..."></textarea>
            </div>
          </div>
        </div>

        <!-- BUTTONS -->
        <div class="d-flex justify-content-end gap-2 pt-3 border-top mt-auto">
          <button class="btn btn-secondary" (click)="onCancelClick()">H·ªßy</button>
          <button class="btn btn-success" (click)="onSaveClick()">
            üíæ L∆∞u
          </button>
        </div>
      </div>
    </div>
  </dx-popup>
</div>