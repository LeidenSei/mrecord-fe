<div class="view-wrapper list-page homeroom-plan">
  <div class="page-header">
    <div class="header-title">
      <i class="dx-icon-bookmark"></i>
      <h2>K·∫ø ho·∫°ch ch·ªß nhi·ªám</h2>
      <span class="count-badge" *ngIf="plansCount > 0">{{plansCount}}</span>
    </div>
    
    <div class="header-actions">
      <button class="btn-add" (click)="addNewPlan()">
        <i class="dx-icon-plus"></i>
        Th√™m k·∫ø ho·∫°ch m·ªõi
      </button>
      <button class="btn-export" (click)="exportData()">
        <i class="dx-icon-export"></i>
        Xu·∫•t Excel
      </button>
    </div>
  </div>

  <div class="filters-container">
    <div class="filter-item">
        <label>NƒÉm h·ªçc</label>
          <dx-drop-down-button
            stylingMode="text"
            [useSelectMode]="true"
            [items]="schoolYearSource"
            (onItemClick)="schoolYearChange($event)"
            [text]="getSchoolYearDisplay(selectedSchoolYear)"
            [dropDownOptions]="{ width: 'auto' }"
            itemTemplate="yearTemplate"
          >
            <div *dxTemplate="let year of 'yearTemplate'">
              {{getSchoolYearDisplay(year)}}
            </div>
          </dx-drop-down-button>
      </div>

    <div class="filter-item">
      <label>H·ªçc k·ª≥</label>
      <dx-select-box
        [dataSource]="semesterSource"
        [(value)]="selectedSemester"
        displayExpr="name"
        valueExpr="value"
        (onValueChanged)="onFilterChange()"
        [width]="150"
      ></dx-select-box>
    </div>

    <div class="filter-item">
      <label>L·ªõp h·ªçc</label>
      <dx-select-box
        [dataSource]="classSourceWithAll"
        [(value)]="filterClassId"
        displayExpr="name"
        valueExpr="id"
        (onValueChanged)="onFilterChange()"
        [width]="200"
      ></dx-select-box>
    </div>

    <div class="filter-item">
      <label>Tr·∫°ng th√°i</label>
      <dx-select-box
        [dataSource]="filterStatusSource"
        [(value)]="selectedStatus"
        displayExpr="name"
        valueExpr="value"
        (onValueChanged)="onFilterChange()"
        [width]="150"
      ></dx-select-box>
    </div>

    <button class="btn-clear-filter" (click)="clearFilters()">
      <i class="dx-icon-clear"></i>
      X√≥a b·ªô l·ªçc
    </button>
  </div>

  <div class="plans-container" *ngIf="filteredDatas.length > 0">
    <div class="plan-card" *ngFor="let plan of filteredDatas">
      <div class="card-header">
        <div class="card-header-left">
          <button class="btn-toggle" (click)="toggleCard(plan.id!)" [title]="isCardCollapsed(plan.id!) ? 'M·ªü chi ti·∫øt' : 'ƒê√≥ng chi ti·∫øt'">
            <i [class]="isCardCollapsed(plan.id!) ? 'dx-icon-chevrondown' : 'dx-icon-chevronup'"></i>
          </button>
          <div class="title-wrapper">
            <h3 class="plan-title">
              <span class="year-badge">{{plan.schoolYear}}-{{plan.schoolYear + 1}}</span>
              <span [ngClass]="getSemesterClass(plan.semester)">
                {{getSemesterText(plan.semester)}}
              </span>
              <span class="class-badge">{{plan.className}}</span>
            </h3>
            <div class="plan-meta">
              <span class="teacher-name">
                <i class="dx-icon-user"></i>
                {{plan.homeRoomTeacherName}}
              </span>
              <span class="plan-date">
                <i class="dx-icon-event"></i>
                {{plan.planDate | date:'dd/MM/yyyy'}}
              </span>
            </div>
          </div>
        </div>
        <div class="card-header-right">
          <span [ngClass]="getStatusClass(plan.status)">
            {{getStatusText(plan.status)}}
          </span>
          <div class="card-actions">
            <button class="btn-icon" (click)="editPlan(plan)" title="Ch·ªânh s·ª≠a">
              <i class="dx-icon-edit"></i>
            </button>
            <button class="btn-icon btn-delete" (click)="deletePlan(plan)" title="X√≥a">
              <i class="dx-icon-trash"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="card-content" *ngIf="!isCardCollapsed(plan.id!)">
        <div class="section section-a" *ngIf="plan.semester === 1">
          <h4 class="section-title">A. T√åNH H√åNH CHUNG</h4>
          <div class="section-content">
            <div class="content-item">
              <div class="item-label">
                <i class="dx-icon-check"></i>
                <strong>Thu·∫≠n l·ª£i:</strong>
              </div>
              <div class="item-text">{{plan.advantages}}</div>
            </div>
            <div class="content-item">
              <div class="item-label">
                <i class="dx-icon-warning"></i>
                <strong>Kh√≥ khƒÉn:</strong>
              </div>
              <div class="item-text">{{plan.difficulties}}</div>
            </div>
          </div>
        </div>

        <div class="section section-b">
          <h4 class="section-title">B. K·∫æ HO·∫†CH GI√ÅO D·ª§C</h4>
          
          <div class="subsection">
            <h5 class="subsection-title">
              <span class="number">1</span>
              TRUY·ªÄN TH·ªêNG - ƒê·∫†O ƒê·ª®C - L·ªêI S·ªêNG
            </h5>
            <div class="subsection-content">
              <div class="content-row">
                <span class="content-label">a) M·ª•c ti√™u:</span>
                <span class="content-text">{{plan.traditionEducation.objectives}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">b) N·ªôi dung:</span>
                <span class="content-text">{{plan.traditionEducation.content}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">c) Gi·∫£i ph√°p:</span>
                <span class="content-text">{{plan.traditionEducation.solutions}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">d) K·∫øt qu·∫£ mong ƒë·ª£i:</span>
                <span class="content-text">{{plan.traditionEducation.expectedResults}}</span>
              </div>
            </div>
          </div>

          <div class="subsection">
            <h5 class="subsection-title">
              <span class="number">2</span>
              H·ªåC T·∫¨P
            </h5>
            <div class="subsection-content">
              <div class="content-row">
                <span class="content-label">a) M·ª•c ti√™u:</span>
                <span class="content-text">{{plan.academicEducation.objectives}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">b) N·ªôi dung:</span>
                <span class="content-text">{{plan.academicEducation.content}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">c) Gi·∫£i ph√°p:</span>
                <span class="content-text">{{plan.academicEducation.solutions}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">d) K·∫øt qu·∫£ mong ƒë·ª£i:</span>
                <span class="content-text">{{plan.academicEducation.expectedResults}}</span>
              </div>
            </div>
          </div>

          <div class="subsection">
            <h5 class="subsection-title">
              <span class="number">3</span>
              C√ÅC M·∫∂T GI√ÅO D·ª§C NGO·∫†I KH√ìA
            </h5>
            <div class="subsection-content">
              <div class="content-row">
                <span class="content-label">a) M·ª•c ti√™u:</span>
                <span class="content-text">{{plan.extracurricularEducation.objectives}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">b) N·ªôi dung:</span>
                <span class="content-text">{{plan.extracurricularEducation.content}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">c) Gi·∫£i ph√°p:</span>
                <span class="content-text">{{plan.extracurricularEducation.solutions}}</span>
              </div>
              <div class="content-row">
                <span class="content-label">d) K·∫øt qu·∫£ mong ƒë·ª£i:</span>
                <span class="content-text">{{plan.extracurricularEducation.expectedResults}}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="additional-info" *ngIf="plan.notes">
          <div class="info-item">
            <i class="dx-icon-comment"></i>
            <strong>Ghi ch√∫:</strong> {{plan.notes}}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="empty-state" *ngIf="filteredDatas.length === 0 && !isLoading">
    <i class="dx-icon-info"></i>
    <h3>Ch∆∞a c√≥ k·∫ø ho·∫°ch n√†o</h3>
    <p>Nh·∫•n n√∫t "Th√™m k·∫ø ho·∫°ch m·ªõi" ƒë·ªÉ t·∫°o k·∫ø ho·∫°ch ch·ªß nhi·ªám</p>
  </div>

  <!-- WIZARD POPUP -->
  <dx-popup
    [(visible)]="popupVisible"
    [showTitle]="true"
    [title]="isEditMode ? 'Ch·ªânh s·ª≠a k·∫ø ho·∫°ch' : 'Th√™m k·∫ø ho·∫°ch m·ªõi'"
    [width]="800"
    [height]="600"
    [dragEnabled]="false"
    [closeOnOutsideClick]="false"
  >
    <div *dxTemplate="let data of 'content'">
      <div style="height: 100%;">

        <!-- STEP INDICATOR - C√ì TH·ªÇ CLICK -->
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
          <div *ngFor="let step of [1,2,3,4,5,6]; let i = index" 
               [style.flex]="1"
               [style.text-align]="'center'"
               [style.opacity]="currentStep === step ? 1 : 0.4"
               [style.font-weight]="currentStep === step ? 'bold' : 'normal'"
               [style.cursor]="'pointer'"
               (click)="goToStep(step)">
            <div [style.width]="'40px'" 
                 [style.height]="'40px'" 
                 [style.border-radius]="'50%'" 
                 [style.background]="currentStep >= step ? '#1890ff' : '#d9d9d9'"
                 [style.color]="'white'"
                 [style.display]="'flex'"
                 [style.align-items]="'center'"
                 [style.justify-content]="'center'"
                 [style.margin]="'0 auto 5px'"
                 [style.transition]="'all 0.3s ease'">
              {{step}}
            </div>
            <small>{{getStepName(step)}}</small>
          </div>
        </div>

        <!-- STEP 1: TH√îNG TIN C∆† B·∫¢N -->
        <div *ngIf="currentStep === 1" style="padding: 20px 0;">
          <h3 style="margin-bottom: 20px;">üìã Th√¥ng tin c∆° b·∫£n</h3>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
              NƒÉm h·ªçc <span style="color: red;">*</span>
            </label>
            <dx-select-box
              [(value)]="tempFormData.schoolYear"
              [dataSource]="schoolYearDisplaySource"
              displayExpr="text"
              valueExpr="value"
              [searchEnabled]="false"
              placeholder="Ch·ªçn nƒÉm h·ªçc"
              [showClearButton]="false"
              [width]="'100%'"
              [stylingMode]="'outlined'"
              [height]="44"
            ></dx-select-box>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
              H·ªçc k·ª≥ <span style="color: red;">*</span>
            </label>
            <dx-select-box
              [(value)]="tempFormData.semester"
              [dataSource]="semesterSource"
              displayExpr="name"
              valueExpr="value"
              [searchEnabled]="false"
              placeholder="Ch·ªçn h·ªçc k·ª≥"
              [showClearButton]="false"
              [width]="'100%'"
              [stylingMode]="'outlined'"
              [height]="44"
            ></dx-select-box>
          </div>

          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">
              L·ªõp h·ªçc <span style="color: red;">*</span>
            </label>
            <dx-select-box
              [(value)]="tempFormData.classId"
              [dataSource]="classSource"
              displayExpr="name"
              valueExpr="id"
              [searchEnabled]="true"
              placeholder="Ch·ªçn l·ªõp"
              [showClearButton]="false"
              [width]="'100%'"
              [stylingMode]="'outlined'"
              [height]="44"
            ></dx-select-box>
          </div>
        </div>

        <!-- STEP 2: T√åNH H√åNH -->
        <div *ngIf="currentStep === 2" style="padding: 20px 0;">
          <h3 style="margin-bottom: 20px;">üìä T√¨nh h√¨nh chung</h3>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Thu·∫≠n l·ª£i</label>
            <textarea 
              [(ngModel)]="tempFormData.advantages"
              rows="6"
              placeholder="Nh·∫≠p nh·ªØng thu·∫≠n l·ª£i trong c√¥ng t√°c gi√°o d·ª•c l·ªõp..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Kh√≥ khƒÉn</label>
            <textarea 
              [(ngModel)]="tempFormData.difficulties"
              rows="6"
              placeholder="Nh·∫≠p nh·ªØng kh√≥ khƒÉn c·∫ßn gi·∫£i quy·∫øt..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
        </div>

        <!-- STEP 3: TRUY·ªÄN TH·ªêNG -->
        <div *ngIf="currentStep === 3" style="padding: 20px 0;">
          <h3 style="margin-bottom: 20px;">üéØ Truy·ªÅn th·ªëng - ƒê·∫°o ƒë·ª©c</h3>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">M·ª•c ti√™u</label>
            <textarea 
              [(ngModel)]="tempFormData.trad_obj"
              rows="4"
              placeholder="M·ª•c ti√™u gi√°o d·ª•c..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">N·ªôi dung</label>
            <textarea 
              [(ngModel)]="tempFormData.trad_con"
              rows="4"
              placeholder="N·ªôi dung c·ª• th·ªÉ..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Gi·∫£i ph√°p</label>
            <textarea 
              [(ngModel)]="tempFormData.trad_sol"
              rows="4"
              placeholder="Gi·∫£i ph√°p th·ª±c hi·ªán..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">K·∫øt qu·∫£ mong ƒë·ª£i</label>
            <textarea 
              [(ngModel)]="tempFormData.trad_res"
              rows="4"
              placeholder="K·∫øt qu·∫£ mong ƒë·ª£i..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
        </div>

        <!-- STEP 4: H·ªåC T·∫¨P -->
        <div *ngIf="currentStep === 4" style="padding: 20px 0;">
          <h3 style="margin-bottom: 20px;">üìö H·ªçc t·∫≠p</h3>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">M·ª•c ti√™u</label>
            <textarea 
              [(ngModel)]="tempFormData.acad_obj"
              rows="4"
              placeholder="M·ª•c ti√™u h·ªçc t·∫≠p..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">N·ªôi dung</label>
            <textarea 
              [(ngModel)]="tempFormData.acad_con"
              rows="4"
              placeholder="N·ªôi dung h·ªó tr·ª£ h·ªçc t·∫≠p..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Gi·∫£i ph√°p</label>
            <textarea 
              [(ngModel)]="tempFormData.acad_sol"
              rows="4"
              placeholder="Gi·∫£i ph√°p n√¢ng cao h·ªçc t·∫≠p..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">K·∫øt qu·∫£ mong ƒë·ª£i</label>
            <textarea 
              [(ngModel)]="tempFormData.acad_res"
              rows="4"
              placeholder="K·∫øt qu·∫£ k·ª≥ v·ªçng..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
        </div>

        <!-- STEP 5: NGO·∫†I KH√ìA -->
        <div *ngIf="currentStep === 5" style="padding: 20px 0;">
          <h3 style="margin-bottom: 20px;">üé® Ngo·∫°i kh√≥a</h3>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">M·ª•c ti√™u</label>
            <textarea 
              [(ngModel)]="tempFormData.extra_obj"
              rows="4"
              placeholder="M·ª•c ti√™u ngo·∫°i kh√≥a..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">N·ªôi dung</label>
            <textarea 
              [(ngModel)]="tempFormData.extra_con"
              rows="4"
              placeholder="N·ªôi dung ho·∫°t ƒë·ªông..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Gi·∫£i ph√°p</label>
            <textarea 
              [(ngModel)]="tempFormData.extra_sol"
              rows="4"
              placeholder="Gi·∫£i ph√°p t·ªï ch·ª©c..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">K·∫øt qu·∫£ mong ƒë·ª£i</label>
            <textarea 
              [(ngModel)]="tempFormData.extra_res"
              rows="4"
              placeholder="K·∫øt qu·∫£ mong ƒë·ª£i..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
        </div>

        <!-- STEP 6: GHI CH√ö -->
        <div *ngIf="currentStep === 6" style="padding: 20px 0;">
          <h3 style="margin-bottom: 20px;">üìù Ho√†n t·∫•t</h3>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Tr·∫°ng th√°i</label>
            <select 
              [(ngModel)]="tempFormData.status"
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;"
            >
              <option value="draft">B·∫£n nh√°p</option>
              <option value="submitted">ƒê√£ n·ªôp</option>
              <option value="approved">ƒê√£ duy·ªát</option>
              <option value="rejected">C·∫ßn s·ª≠a</option>
            </select>
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Ghi ch√∫</label>
            <textarea 
              [(ngModel)]="tempFormData.notes"
              rows="8"
              placeholder="Ghi ch√∫ b·ªï sung (n·∫øu c√≥)..."
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit;"
            ></textarea>
          </div>
        </div>

        <!-- NAVIGATION BUTTONS -->
        <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 20px; border-top: 1px solid #ddd;">
          <button 
            (click)="onCancelClick()"
            style="padding: 10px 24px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 14px;">
            H·ªßy
          </button>
          
          <button 
            (click)="onSaveClick()"
            style="padding: 10px 24px; background: #52c41a; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
            üíæ L∆∞u
          </button>
        </div>

      </div>
    </div>
  </dx-popup>
</div>