<div class="view-wrapper list-page class-committee">
  <dx-popup
    [(visible)]="showAddModal"
    [showTitle]="true"
    [title]="isEditMode ? 'Sửa chức vụ hàng loạt' : 'Thêm ban cán sự lớp'"
    [width]="900"
    [height]="600"
    [showCloseButton]="true"
    [dragEnabled]="false"
  >
    <div class="multi-select-container">
      <div class="selection-panel" *ngIf="!isEditMode">
        <h3>Chọn học sinh</h3>
        <dx-list
          [dataSource]="studentSource"
          [height]="400"
          [searchEnabled]="true"
          searchExpr="fullName"
          [showSelectionControls]="true"
          selectionMode="multiple"
          [(selectedItems)]="selectedStudents"
          itemTemplate="studentItem"
        >
          <div *dxTemplate="let student of 'studentItem'">
            <div class="student-item">
              <div class="student-name">{{student.fullName}}</div>
              <div class="student-info">
                <span class="student-code">{{student.code}}</span>
                <span class="student-class">{{student.className}}</span>
              </div>
            </div>
          </div>
        </dx-list>
        <div class="selection-count">
          Đã chọn: <strong>{{selectedStudents.length}}</strong> học sinh
        </div>
      </div>

      <div class="selection-panel" *ngIf="isEditMode" [ngClass]="{'full-width': isEditMode}">
        <h3>Học sinh được chọn ({{selectedStudents.length}})</h3>
        <div class="selected-students-list">
          <div *ngFor="let student of selectedStudents" class="student-item selected">
            <div class="student-name">{{student.fullName}}</div>
            <div class="student-info">
              <span class="student-code">{{student.code}}</span>
              <span class="student-class">{{student.className}}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="selection-panel" [ngClass]="{'full-width': isEditMode}">
        <h3>Chọn chức vụ mới</h3>
        <dx-list
          [dataSource]="positionSource"
          [height]="400"
          displayExpr="name"
          [showSelectionControls]="true"
          selectionMode="multiple"
          [(selectedItems)]="selectedPositions"
          itemTemplate="positionItem"
        >
          <div *dxTemplate="let position of 'positionItem'">
            <div class="position-item">
              <span class="badge badge-lg" [ngClass]="getPositionClass(position.value)">
                {{position.name}}
              </span>
            </div>
          </div>
        </dx-list>
        <div class="selection-count">
          Đã chọn: <strong>{{selectedPositions.length}}</strong> chức vụ
        </div>
      </div>
    </div>

    <div class="modal-summary">
      <i class="dx-icon-info"></i>
      <span *ngIf="!isEditMode">
        Sẽ tạo <strong>{{selectedStudents.length * selectedPositions.length}}</strong> phân công
        ({{selectedStudents.length}} học sinh × {{selectedPositions.length}} chức vụ)
      </span>
      <span *ngIf="isEditMode">
        Sẽ cập nhật <strong>{{selectedStudents.length}}</strong> học sinh sang 
        <strong>{{selectedPositions.length}}</strong> chức vụ mới
        (Tạo {{selectedStudents.length * selectedPositions.length}} bản ghi, xóa {{selectedRows.length}} bản ghi cũ)
      </span>
    </div>

    <div class="modal-footer">
      <dx-button
        text="Hủy"
        stylingMode="outlined"
        (onClick)="closeAddModal()"
      ></dx-button>
      <dx-button
        text="Lưu"
        type="success"
        stylingMode="contained"
        (onClick)="saveMultipleAssignments()"
      ></dx-button>
    </div>
  </dx-popup>

  <dx-data-grid
    class="grid theme-dependent"
    [rowAlternationEnabled]="true"
    noDataText=""
    columnResizingMode="widget"
    [dataSource]="datas"
    [allowColumnReordering]="true"
    [showBorders]="true"
    [showColumnLines]="true"
    [showRowLines]="true"
    [columnMinWidth]="50"
    [columnAutoWidth]="true"
    [columnResizingMode]="'nextColumn'"
    [allowColumnResizing]="true"
    [repaintChangesOnly]="true"
    (onExporting)="onExporting($event)"
    (onRowUpdating)="onRowUpdating($event)"
    (onRowInserting)="onRowInserting($event)"
    (onRowRemoving)="onRowRemoving($event)"
    (onSelectionChanged)="onSelectionChanged($event)"
    keyExpr="id"
  >
    <dxo-selection mode="multiple" showCheckBoxesMode="always"></dxo-selection>
    <dxo-scrolling mode="virtual" rowRenderingMode="virtual"></dxo-scrolling>
    <dxo-load-panel [showPane]="true" [enabled]="true"></dxo-load-panel>
    <dxo-sorting mode="multiple"></dxo-sorting>
    <dxo-header-filter [visible]="true"></dxo-header-filter>
    <dxo-column-chooser [enabled]="true"></dxo-column-chooser>
    
    <dxo-editing
      mode="popup"
      [allowUpdating]="true"
      [allowAdding]="false"
      [allowDeleting]="true"
      [useIcons]="true"
    >
      <dxo-popup
        title="Chỉnh sửa thông tin ban cán sự"
        [showTitle]="true"
        [width]="500"
        [height]="500"
      ></dxo-popup>
      <dxo-form [colCount]="2">
        <!-- Hiển thị tên học sinh -->
        <dxi-item 
          dataField="studentName" 
          caption="Học sinh"
          [colSpan]="2"
          editorType="dxTextBox"
          [editorOptions]="{
            readOnly: true
          }"
        ></dxi-item>
        
        <!-- Hiển thị lớp -->
        <dxi-item 
          dataField="className" 
          caption="Lớp"
          editorType="dxTextBox"
          [editorOptions]="{
            readOnly: true
          }"
        ></dxi-item>
        
        <!-- Chức vụ - tự động chọn giá trị hiện tại -->
        <dxi-item 
          dataField="positionId" 
          caption="Chức vụ"
          [isRequired]="true"
          editorType="dxSelectBox"
          [editorOptions]="{
            dataSource: positionSource,
            displayExpr: 'name',
            valueExpr: 'id',
            placeholder: 'Chọn chức vụ...'
          }"
        ></dxi-item>
        
        <dxi-item 
          dataField="teamNumber" 
          caption="Tổ"
          editorType="dxSelectBox"
          [editorOptions]="{
            dataSource: teamSource,
            displayExpr: 'name',
            valueExpr: 'value',
            placeholder: 'Chọn tổ...',
            showClearButton: true
          }"
        ></dxi-item>
        
        <dxi-item 
          caption="Lần bầu cử"
          dataField="electionRound" 
          editorType="dxNumberBox"
          [editorOptions]="{
            min: 1,
            showSpinButtons: true
          }"
        ></dxi-item>
        
        <dxi-item 
          dataField="notes" 
          caption="Ghi chú"
          [colSpan]="2"
          editorType="dxTextArea"
          [editorOptions]="{
            height: 80,
            placeholder: 'Nhập ghi chú...'
          }"
        ></dxi-item>
      </dxo-form>
    </dxo-editing>
    
    <dxo-export
      [enabled]="true"
      [texts]="exportTexts"
      [allowExportSelectedData]="false"
      [formats]="['xlsx']"
    ></dxo-export>
    
    <dxo-toolbar>
      <dxi-item location="after" locateInMenu="never">
        <div *dxTemplate>
          <dx-button
            icon="plus"
            text="Thêm"
            type="default"
            stylingMode="contained"
            (onClick)="openAddModal()"
          ></dx-button>
        </div>
      </dxi-item>
        
      <dxi-item name="exportButton"></dxi-item>
      
      <dxi-item location="before">
        <div *dxTemplate class="grid-header">
          <i class="dx-icon-user"></i>
          Ban cán sự lớp 
          <span *ngIf="committeeCount > 0">&nbsp;({{committeeCount}})</span>
        </div>
      </dxi-item>
      
      <dxi-item location="before" locateInMenu="auto">
        <div *dxTemplate>
          <label>Năm học:</label>
        </div>
      </dxi-item>
      <dxi-item location="before" locateInMenu="auto">
        <div *dxTemplate>
          <dx-drop-down-button
            stylingMode="text"
            [useSelectMode]="true"
            [items]="schoolYearSource"
            (onItemClick)="schoolYearChange($event)"
            [text]="getSchoolYearDisplay(selectedSchoolYear)"
            [dropDownOptions]="{ width: 'auto' }"
            itemTemplate="yearTemplate"
          >
            <div *dxTemplate="let year of 'yearTemplate'">
              {{getSchoolYearDisplay(year)}}
            </div>
          </dx-drop-down-button>
        </div>
      </dxi-item>
      
      <dxi-item location="before" locateInMenu="auto">
        <div *dxTemplate>
          <label>Lần BC:</label>
        </div>
      </dxi-item>
      <dxi-item location="before" locateInMenu="auto">
        <div *dxTemplate>
          <dx-drop-down-button
            stylingMode="text"
            [useSelectMode]="true"
            [items]="electionRoundSource"
            keyExpr="value"
            displayExpr="name"
            (onItemClick)="electionRoundChange($event)"
            [text]="selectedElectionRoundText"
            [dropDownOptions]="{ width: 'auto' }"
          ></dx-drop-down-button>
        </div>
      </dxi-item>
      
      <dxi-item location="before" locateInMenu="auto">
        <div *dxTemplate>
          <label>Khối:</label>
        </div>
      </dxi-item>
      <dxi-item location="before" locateInMenu="auto">
        <div *dxTemplate>
          <dx-drop-down-button
            stylingMode="text"
            [useSelectMode]="true"
            [items]="gradeSource"
            (onItemClick)="gradeChange($event)"
            [text]="selectedGrade"
            [dropDownOptions]="{ width: 'auto' }"
          ></dx-drop-down-button>
        </div>
      </dxi-item>
      
      <dxi-item location="before" locateInMenu="auto">
        <div *dxTemplate>
          <label>Lớp:</label>
        </div>
      </dxi-item>
      <dxi-item location="before" locateInMenu="auto">
        <div *dxTemplate>
          <dx-drop-down-button
            [text]="selectedClassText"
            stylingMode="text"
            [items]="filterClassSource"
            keyExpr="id"
            displayExpr="name"
            (onItemClick)="classChange($event)"
            [dropDownOptions]="{ width: 'auto' }"
          ></dx-drop-down-button>
        </div>
      </dxi-item>
    </dxo-toolbar>
    
    <dxi-column 
      dataField="studentName" 
      caption="Họ và tên" 
      [width]="220"
      [allowEditing]="false"
    ></dxi-column>

    <dxi-column 
      dataField="className" 
      caption="Lớp" 
      [width]="120"
      alignment="center"
      [allowEditing]="false"
    ></dxi-column>
    
    <dxi-column 
      dataField="positionId" 
      caption="Chức vụ" 
      [width]="150"
      cellTemplate="cellPosition"
    ></dxi-column>
    
    <dxi-column 
      dataField="teamNumber" 
      caption="Tổ" 
      [width]="120"
      alignment="center"
      cellTemplate="cellTeam"
    ></dxi-column>

    <dxi-column 
      dataField="isActive" 
      caption="Trạng thái" 
      [width]="120"
      alignment="center"
      cellTemplate="cellStatus"
    ></dxi-column>

    <dxi-column 
      type="buttons" 
      [width]="100" 
      fixedPosition="right"
      caption="Thao tác"
    >
      <dxi-button name="edit" icon="edit" hint="Sửa"></dxi-button>
      <dxi-button name="delete" icon="trash" hint="Xóa"></dxi-button>
    </dxi-column>

    <div *dxTemplate="let cellInfo of 'cellPosition'">
      <span class="badge" [ngClass]="getPositionClass(cellInfo.data.positionId)">
        {{cellInfo.data.positionName}}
      </span>
    </div>
    
    <div *dxTemplate="let cellInfo of 'cellTeam'">
      <span *ngIf="cellInfo.value" class="badge badge-info">
        Tổ {{cellInfo.value}}
      </span>
      <span *ngIf="!cellInfo.value && needsTeam(cellInfo.data.positionId)" class="text-muted">
        <i>Chưa phân tổ</i>
      </span>
      <span *ngIf="!cellInfo.value && !needsTeam(cellInfo.data.positionId)">
        -
      </span>
    </div>

    <div *dxTemplate="let cellInfo of 'cellStatus'">
      <span class="badge" [ngClass]="getStatusClass(cellInfo.value)">
        {{getStatusText(cellInfo.value)}}
      </span>
    </div>

  </dx-data-grid>
</div>