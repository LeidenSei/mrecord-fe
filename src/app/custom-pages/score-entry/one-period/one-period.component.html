<div class="score-entry-container">
  <div class="main-content-wrapper">
    <div class="header-controls">
      <div class="filter-section">
        <div class="filter-group">
          <label>Theo lớp</label>
          <select class="form-select" [(ngModel)]="selectedClass" (change)="onClassChanged()">
            <option value="5B">5B</option>
            <option value="5A">5A</option>
            <option value="6A">6A</option>
            <option value="6B">6B</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Theo tháng</label>
          <select class="form-select" [(ngModel)]="selectedMonth" (change)="onMonthChanged()">
            <option value="7/2025">7/2025</option>
            <option value="6/2025">6/2025</option>
            <option value="8/2025">8/2025</option>
            <option value="9/2025">9/2025</option>
          </select>
        </div>
      </div>
      
      <div class="action-buttons">
        <dx-button
          text="Gửi thông tin"
          icon="email"
          type="danger"
          (onClick)="sendNotification()">
        </dx-button>
        <div class="dropdown-container">
          <button class="dropdown-btn" (click)="toggleImportDropdown()">
            <div class="dropdown-main">
              <span class="icon">⬆</span>
              <span class="text">Nhập/Xuất dữ liệu</span>
            </div>
            <div class="dropdown-arrow">
              <span>▼</span>
            </div>
          </button>
        </div>
        <dx-button
          text="Cấu hình mẫu nhận xét"
          icon="doc"
          type="default"
          (onClick)="generateTemplate()">
        </dx-button>
        <dx-button
          text="Lưu nhận xét"
          icon="save"
          type="default"
          (onClick)="saveComments()">
        </dx-button>
      </div>
    </div>

    <!-- ag-Grid thay thế cho table -->
    <div class="grid-container">
      <ag-grid-angular
        class="ag-theme-quartz student-grid"
        [columnDefs]="columnDefs"
        [defaultColDef]="defaultColDef"
        [rowData]="studentList"
        [rowSelection]="rowSelection"
        [suppressRowClickSelection]="true"
        [animateRows]="true"
        [enableRangeSelection]="true"
        [enableFillHandle]="true"
        [undoRedoCellEditing]="true"
        [stopEditingWhenCellsLoseFocus]="true"
        [enterNavigatesVertically]="true"
        [enterNavigatesVerticallyAfterEdit]="true"
        [suppressHorizontalScroll]="false"
        [context]="gridContext"
        (gridReady)="onGridReady($event)"
        (cellClicked)="onCellClicked($event)"
        (cellEditingStopped)="onCellEditingStopped($event)"
        (selectionChanged)="onSelectionChanged($event)">
      </ag-grid-angular>
    </div>

    <div class="footer-legend">
      <div class="legend-item">
        <span class="legend-color red-box"></span>
        <span>Giá trị chưa gửi tin nhắn đến học sinh</span>
      </div>
      <div class="legend-item">
        <span class="legend-color gray-box"></span>
        <span>Giá trị đã gửi tin nhắn đến học sinh</span>
      </div>
      <div class="legend-item">
        <span class="legend-color blue-box"></span>
        <span>Học sinh đã kích hoạt dịch vụ</span>
      </div>
    </div>
  </div>

  <!-- Modal chọn comment -->
  <dx-popup
    [(visible)]="showCommentModal"
    [showTitle]="true"
    title="Chọn nhận xét có sẵn"
    [dragEnabled]="false"
    [closeOnOutsideClick]="true"
    [width]="600"
    [height]="500"
    [showCloseButton]="true"
    (onHiding)="closeCommentModal()">
    
    <div *dxTemplate="let data of 'content'">
      <div class="modal-content">
        <dx-text-box
          [(value)]="searchText"
          placeholder="Tìm kiếm nhận xét..."
          [showClearButton]="true"
          (onValueChanged)="filterComments()"
          class="search-input">
          <dx-button
            name="search"
            location="after"
            icon="search"
            stylingMode="text">
          </dx-button>
        </dx-text-box>

        <div class="comment-categories" *ngIf="filteredComments.length > 0">
          <div *ngFor="let category of getUniqueCategories(filteredComments)" class="category-section">
            <h4 class="category-title">{{ category }}</h4>
            <div class="comment-list">
              <div 
                *ngFor="let comment of getCommentsByCategory(filteredComments, category)"
                class="comment-item"
                (click)="selectComment(comment)">
                <div class="comment-text">{{ comment.text }}</div>
                <dx-button
                  text="Chọn"
                  type="default"
                  stylingMode="contained"
                  class="select-btn">
                </dx-button>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="filteredComments.length === 0" class="no-results">
          <i class="dx-icon-search"></i>
          <p>Không tìm thấy nhận xét nào phù hợp</p>
        </div>
      </div>
    </div>

    <div *dxTemplate="let data of 'toolbarItems'">
      <dx-button
        text="Đóng"
        type="normal"
        stylingMode="contained"
        (onClick)="closeCommentModal()">
      </dx-button>
    </div>
  </dx-popup>
</div>