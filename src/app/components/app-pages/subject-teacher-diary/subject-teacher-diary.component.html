<div class="container" style="background: #FFF;height: 100vh">
  <h4 class="mb-3 pt-3">Danh sách tiết dạy</h4>

  <!-- Bộ lọc -->
  <div class="d-flex mb-3 gap-2">
    <dx-date-box
      [(value)]="filterDate"
      placeholder="Từ ngày"
      type="date"
      width="60%"
      displayFormat="dd/MM/yyyy"
      [showClearButton]="true"
      [min]="minDate"
      [max]="maxDate"
      (onValueChanged)="onDateChanged($event)"
    ></dx-date-box>
    <dx-text-box
      [value]="'Tuần ' + filterWeek"
      [readOnly]="true"
      stylingMode="outlined"
      width="30%">
    </dx-text-box>
    <dx-button icon="plus" type="default" (onClick)="openForm(null)" width="10%"></dx-button>
  </div>

  <!-- List -->
  <dx-tree-list
    [dataSource]="treeScheduleData"
    [keyExpr]="'id'"
    [parentIdExpr]="'parentId'"
    [showBorders]="true"
    [autoExpandAll]="true">
    <dxi-column dataField="name" caption="Tên"></dxi-column>
    <dxi-column dataField="extra" caption="Thông tin"></dxi-column>
    <dxi-column caption="" [width]="90" cellTemplate="actionTemplate"></dxi-column>
    <div *dxTemplate="let data of 'actionTemplate'">
      <dx-button
        *ngIf="data.data.extra && data.data.hasData"
        icon="edit"
        type="success"
        stylingMode="contained"
        (onClick)="openForm(data.data)">
      </dx-button>
      <dx-button
        *ngIf="data.data.extra && !data.data.hasData"
        icon="plus"
        type="default"
        stylingMode="contained"
        (onClick)="openForm(data.data)">
      </dx-button>
    </div>
  </dx-tree-list>
  <div *ngIf="extraSessionArr.length" style="margin-top: 10px">
    <h4 styl="font-size: 16px;">Tiết dạy ngoài TKB</h4>
    <dx-list
      [dataSource]="extraSessionArr"
      displayExpr="lessonName"
      height="auto"
      [noDataText]="'Chưa có tiết nào'">

      <div *dxTemplate="let item of 'item'">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <b>{{ item.className }}</b> - {{ item.subjectName }} <br>
            <small>{{ item.dayTimeText }}, {{ item.periodText }}</small>
          </div>
          <dx-button icon="trash" stylingMode="text" (onClick)="removeExtraLesson(item)"></dx-button>
        </div>
      </div>
    </dx-list>
  </div>
  <!--<dx-list
    [dataSource]="lessons"
    displayExpr="mon"
    selectionMode="none"
    [height]="'70vh'"
    [searchEnabled]="true"
    searchExpr="className">

    <div *dxTemplate="let data of 'item'">
      <div class="d-flex justify-content-between align-items-center p-2">
        <div>
          <div><strong>{{data.periodText}}</strong> - Lớp {{data.className}}</div>
        </div>
        <dx-button icon="edit" type="success" stylingMode="contained" (onClick)="openForm(data)">

        </dx-button>
      </div>
    </div>
  </dx-list>-->
</div>

<!-- Popup nhập -->
<dx-popup
  [(visible)]="popupVisible"
  [showCloseButton]="true"
  [width]="'95%'"
  title="Nhập sổ đầu bài">

  <div *dxTemplate="let data of 'content'">

    <dx-form
      [formData]="selectedLesson"
      [colCount]="2"
      (onFieldDataChanged)="onFormFieldChanged($event)"
      [labelLocation]="'top'">
      <dxi-item dataField="isExtraSession" editorType="dxSwitch"
                [colSpan]="2"
                [label]="{ text: 'Trái buổi (ngoài TKB)' }"
                [editorOptions]="{
            switchedOnText: 'Có',
            switchedOffText: 'Không'
          }">
      </dxi-item>
      <!-- Lớp học -->
      <dxi-item dataField="classId" editorType="dxSelectBox"
                [label]="{ text: 'Lớp học' }"
                [editorOptions]="{
              dataSource: classes,
              displayExpr: 'name',
              valueExpr: 'id',
              searchEnabled: true,
              placeholder: 'Chọn lớp học',
              readOnly: !selectedLesson.isExtraSession,
            }">
      </dxi-item>

      <!-- Môn học -->
      <dxi-item dataField="subjectId" editorType="dxSelectBox"
                [label]="{ text: 'Môn học' }"
                [editorOptions]="{
              dataSource: subjects,
              displayExpr: 'name',
              valueExpr: 'id',
              searchEnabled: true,
              placeholder: 'Chọn môn học',
              readOnly: !selectedLesson.isExtraSession
            }">
      </dxi-item>

      <!-- Buổi học -->
      <dxi-item dataField="dayTime" editorType="dxSelectBox"
                [label]="{ text: 'Buổi học' }"
                [editorOptions]="{
              dataSource: dayTimes,
              displayExpr: 'text',
              valueExpr: 'value',
              searchEnabled: true,
              placeholder: 'Chọn buổi',
              readOnly: !selectedLesson.isExtraSession

            }">
      </dxi-item>

      <!-- Tiết học -->
      <dxi-item dataField="period" editorType="dxSelectBox"
                [label]="{ text: 'Tiết học' }"
                [editorOptions]="{
              dataSource: periods,
              displayExpr: 'text',
              valueExpr: 'value',
              searchEnabled: true,
              placeholder: 'Chọn tiết',
              readOnly: !selectedLesson.isExtraSession
            }">
      </dxi-item>

      <!-- Bài học -->
      <dxi-item [colSpan]="2" dataField="lessonName" [label]="{ text: 'Tên bài học' }"></dxi-item>
      <dxi-item [colSpan]="2" dataField="comment" editorType="dxTextArea"
                [label]="{ text: 'Nhận xét' }"
                [editorOptions]="{
            height: 90,
            placeholder: 'Nhập nhận xét...',
            autoResizeEnabled: true
          }">
      </dxi-item>

      <dxi-item dataField="attendanceScore" editorType="dxNumberBox"
                [label]="{ text: 'Chuyên cần' }"
                [editorOptions]="{ onValueChanged: onScoreChanged.bind(this) }">
      </dxi-item>

      <dxi-item dataField="studyScore" editorType="dxNumberBox"
                [label]="{ text: 'Học tập' }"
                [editorOptions]="{ onValueChanged: onScoreChanged.bind(this) }">
      </dxi-item>

      <dxi-item dataField="disciplineScore" editorType="dxNumberBox"
                [label]="{ text: 'Kỷ luật' }"
                [editorOptions]="{ onValueChanged: onScoreChanged.bind(this) }">
      </dxi-item>

      <dxi-item dataField="cleanlinessScore" editorType="dxNumberBox"
                [label]="{ text: 'Vệ sinh' }"
                [editorOptions]="{ onValueChanged: onScoreChanged.bind(this) }">
      </dxi-item>

      <dxi-item dataField="totalPeriods" editorType="dxNumberBox"
                [label]="{ text: 'Tổng tiết' }"
                [editorOptions]="{ readOnly: true }">
      </dxi-item>

      <dxi-item dataField="totalScore" editorType="dxNumberBox"
                [label]="{ text: 'Tổng điểm' }"
                [editorOptions]="{ readOnly: true }">
      </dxi-item>
    </dx-form>
    <h4 class="mt-3" style="font-size: 18px">Học sinh vắng</h4>
    <dx-data-grid
      [dataSource]="selectedLesson.absences"
      [editing]="{ mode: 'row', allowAdding: true, allowUpdating: true, allowDeleting: true }"
      [columns]="[
    { dataField: 'studentId', caption: 'Học sinh', lookup: { dataSource: students, displayExpr: 'name', valueExpr: 'id' } },
    { dataField: 'absenceType', caption: 'Loại', lookup: { dataSource: [{ value: 'CP', text: 'Có phép'}, { value: 'KP', text: 'Không phép'}], displayExpr: 'text', valueExpr: 'value' } }
  ]">
    </dx-data-grid>
    <!--<div class="mt-3 text-end">
      <dx-button text="Lưu" type="default" (onClick)="saveLesson()"></dx-button>
    </div>-->
  </div>
  <dxi-toolbar-item toolbar="bottom" location="after">
    <div
      class="form-popup-buttons-container"
    >
      <dx-button
        text="Bỏ qua"
        stylingMode="outlined"
        type="normal"
        (onClick)="popupVisible = false"
      ></dx-button>
      <dx-button
        text="Cập nhật"
        stylingMode="contained"
        type="default"
        (onClick)="saveLesson()"
      ></dx-button>
    </div>
  </dxi-toolbar-item>
</dx-popup>
